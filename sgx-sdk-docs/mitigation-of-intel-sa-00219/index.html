<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-teaclave-sgx-sdk/documents/mitigation-of-intel-sa-00219-in-rust-sgx" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Background | Apache Teaclave™ (incubating)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://teaclave.apache.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://teaclave.apache.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://teaclave.apache.org/sgx-sdk-docs/mitigation-of-intel-sa-00219"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Background | Apache Teaclave™ (incubating)"><meta data-rh="true" name="description" content="Intel issued Intel SA-00219 on Nov 12, 2019, with CVE number CVE-2019-0117. Intel also published a guidance to instruct the developers/researchers. Then Intel released Intel SGX SDK v2.7.1, including new memory allocation primitives and corresponding patches in PSW enclaves."><meta data-rh="true" property="og:description" content="Intel issued Intel SA-00219 on Nov 12, 2019, with CVE number CVE-2019-0117. Intel also published a guidance to instruct the developers/researchers. Then Intel released Intel SGX SDK v2.7.1, including new memory allocation primitives and corresponding patches in PSW enclaves."><link data-rh="true" rel="canonical" href="https://teaclave.apache.org/sgx-sdk-docs/mitigation-of-intel-sa-00219"><link data-rh="true" rel="alternate" href="https://teaclave.apache.org/sgx-sdk-docs/mitigation-of-intel-sa-00219" hreflang="en"><link data-rh="true" rel="alternate" href="https://teaclave.apache.org/sgx-sdk-docs/mitigation-of-intel-sa-00219" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Mitigation of Intel SA 00219 in Rust-SGX","item":"https://teaclave.apache.org/sgx-sdk-docs/mitigation-of-intel-sa-00219"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Teaclave™ (incubating) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Teaclave™ (incubating) Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e2b519a3.css">
<script src="/assets/js/runtime~main.b9db7108.js" defer="defer"></script>
<script src="/assets/js/main.d9920c39.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Apache Teaclave™" class="themedComponent_mlkZ themedComponent--light_NVdE" style="height:2.5rem;max-width:300px;padding-left:1.6rem;position:relative;top:0.1rem"><img src="/img/logo.svg" alt="Apache Teaclave™" class="themedComponent_mlkZ themedComponent--dark_xIcU" style="height:2.5rem;max-width:300px;padding-left:1.6rem;position:relative;top:0.1rem"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/powered-by">Powered By</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" file="community/community.md" href="/community">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" file="community/contributing.md" href="/contributing">Contributing</a></li><li><a class="dropdown__link" file="community/contributors.md" href="/contributors">Contributors</a></li><li><a class="dropdown__link" file="community/becoming-a-member.md" href="/becoming-a-member">Becoming a Member</a></li><li><a class="dropdown__link" file="community/maturity.md" href="/maturity">Maturity Assessment</a></li><li><a class="dropdown__link" file="community/release-guide.md" href="/release-guide">Release Guide</a></li></ul></div><a class="navbar__item navbar__link" href="/download">Download</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" file="overview.md" href="/overview">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" file="teaclave-trustzone-sdk/docs/README.md" href="/trustzone-sdk-docs/">Teaclave TrustZone SDK</a></li><li><a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee_teec" target="_self" rel="" class="dropdown__link">API Docs: Teaclave TrustZone SDK (Host)<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee_utee" target="_self" rel="" class="dropdown__link">API Docs: Teaclave TrustZone SDK (TA)<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" file="teaclave-sgx-sdk/documents/README.md" href="/sgx-sdk-docs/">Teaclave SGX SDK</a></li><li><a href="https://teaclave.apache.org/api-docs/sgx-sdk/" target="_self" rel="" class="dropdown__link">API Docs: Teaclave SGX SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a class="dropdown__link" file="teaclave-docs/README.md" href="/teaclave-docs/">Teaclave</a></li><li><a class="dropdown__link" file="teaclave-faas-legacy/docs/README.md" href="/docs/">Teaclave FaaS (legacy)</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Repos</a><ul class="dropdown__menu"><li><a href="https://github.com/apache/incubator-teaclave" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-sgx-sdk" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave SGX SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-trustzone-sdk" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave TrustZone SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-java-tee-sdk" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave Java TEE SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-website" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave Website<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">ASF Homepage<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/sgx-sdk-docs/environment-setup">Development</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sgx-sdk-docs/environment-setup">Setting up your Development Environment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sgx-sdk-docs/sgx_in_mesalock_linux">Rust SGX Applications in Mesalock Linux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sgx-sdk-docs/is_x86_feature_detected-in-sgx-sdk">`is_x86_feature_detected` in Teaclave SGX SDK</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sgx-sdk-docs/developing-with-vscode">Developing with Visual Studio Code</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sgx-sdk-docs/debugging-a-local-rust-sgx-enclave">Debugging a Local Enclave in Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sgx-sdk-docs/public-cloud-for-rust-sgx-dev">Public Cloud Rust SGX Development</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sgx-sdk-docs/the-world-of-forked-crates">The World of Forked Crates</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/sgx-sdk-docs/sgxtime">Tutorials</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sgx-sdk-docs/sgxtime">Acquiring Trusted Timestamp from Intel ME in SGX enclave</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/sgx-sdk-docs/everything-about-cve-2020-5499">Security</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/sgx-sdk-docs/everything-about-cve-2020-5499">Everything about CVE-2020-5499</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/sgx-sdk-docs/mitigation-of-intel-sa-00219">Mitigation of Intel SA 00219 in Rust-SGX</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a href="https://www.ieee-security.org/TC/SP2019/posters/hotcrp_sp19posters-final11.pdf" target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true">Applications</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a href="https://www.ieee-security.org/TC/SP2019/posters/hotcrp_sp19posters-final11.pdf" target="_blank" rel="noopener noreferrer" class="menu__link menuExternalLink_NmtK" tabindex="0">Fast and Trustworthy Gradient Boosting Decision Tree<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Security</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Mitigation of Intel SA 00219 in Rust-SGX</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Background</h1></header>
<p>Intel issued <a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00219.html" target="_blank" rel="noopener noreferrer">Intel SA-00219</a> on Nov 12, 2019, with CVE number <a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-0117" target="_blank" rel="noopener noreferrer">CVE-2019-0117</a>. Intel also published a <a href="https://software.intel.com/en-us/download/intel-sgx-sdk-developer-guidance-intel-sa-00219" target="_blank" rel="noopener noreferrer">guidance</a> to instruct the developers/researchers. Then Intel released <a href="https://01.org/intel-softwareguard-extensions/downloads/intel-sgx-linux-2.7.1-release-version-string-2.7.101.3" target="_blank" rel="noopener noreferrer">Intel SGX SDK v2.7.1</a>, including new memory allocation primitives and corresponding patches in PSW enclaves.</p>
<p>This article is to help people understand Intel-SA-00219, and how Rust SGX SDK handles it. Please feel free to reach me at <a href="mailto:dingelish@gmail.com" target="_blank" rel="noopener noreferrer">dingelish@gmail.com</a>, or <a href="mailto:dingyu@apache.org" target="_blank" rel="noopener noreferrer">dingyu@apache.org</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-problem-statement-and-my-thoughts">The problem statement and my thoughts<a href="#the-problem-statement-and-my-thoughts" class="hash-link" aria-label="Direct link to The problem statement and my thoughts" title="Direct link to The problem statement and my thoughts">​</a></h2>
<p>The only statement I found is on the <a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00219.html" target="_blank" rel="noopener noreferrer">Intel-SA-00219 page</a>:</p>
<blockquote>
<p>Organize the code/data within enclave memory to avoid putting sensitive materials in DWORD0 and DWORD1 of cache line. The effectiveness of this mitigation is dependent on the ability for the software to avoid the affected memory region. To assist the enclave application providers to modify their code, Intel is releasing SGX SDK update (Windows version 2.5.101.3, Linux version 2.7.101.3) with new memory allocation APIs to avoid the affected memory region. More details about the APIs can be found <a href="https://software.intel.com/en-us/download/intel-sgx-sdk-developer-guidance-intel-sa-00219" target="_blank" rel="noopener noreferrer">here</a>.</p>
</blockquote>
<p>Intel does not directly describe the vulnerability here. But it&#x27;s clear that the 64-byte cache line would contain 8-byte or sensitive data, which can be keys protected by Intel SGX. So the following memory layout can be problematic in SGX:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> --------------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| attacker accessible data A | private key (inaccessible) | attacker accessible data B |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> --------------------------------------------------------------------------------------</span><br></span></code></pre></div></div>
<p>It&#x27;s equal to a vulnerable data structure like:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct foo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t A;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t secret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>where <code>foo.A</code> and <code>foo.B</code> are accessible by design, while <code>foo.secret</code> is not.</p>
<p>If an attacker somehow can access either A or B, he probably will have first or last 8-byte of the &quot;inaccessible&quot; secret in cache line. Then something bad may happen.</p>
<p>So, the most straightforward mitigation is to insert additional &quot;guard bytes&quot; before and after the sensitive data:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> ----------------------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| attacker data A | 8-byte guard | private key (inaccessible) | 8-byte guard | attacker data B |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ----------------------------------------------------------------------------------------------</span><br></span></code></pre></div></div>
<p>It results in a modified structure like</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct foo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t A;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (private) uint64_t _guard0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t secret;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    (private) uint64_t _guard1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    uint64_t B;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Further investigation from Intel&#x27;s code reveals that <code>_guard1</code> is not required. So it can be:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">     -------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    | attacker data A | 8-byte guard | private key (inaccessible) | attacker data B |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     -------------------------------------------------------------------------------</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="intels-new-allocator-primitive">Intel&#x27;s new allocator primitive<a href="#intels-new-allocator-primitive" class="hash-link" aria-label="Direct link to Intel&#x27;s new allocator primitive" title="Direct link to Intel&#x27;s new allocator primitive">​</a></h2>
<p>Intel&#x27;s guidance provides:</p>
<p>(1) A C++ template <code>custom_alignment_aligned</code>
(2) A C function <code>sgx_get_aligned_ptr</code> and one of its parameter&#x27;s type <code>struct align_req_t</code>
(3) A dynamic memory allocator function <code>sgx_aligned_malloc</code></p>
<p>After spending hours on Intel&#x27;s code, I realized that these primitives are helping developers allocate a larger object which:</p>
<p>a) contains all fields of the original object.
b) adds &quot;guard bytes&quot; before and after each &quot;specified secret field&quot;.
c) align each &quot;specified secret field&quot; on demand</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="intels-patches-on-psw-enclaves">Intel&#x27;s patches on PSW enclaves<a href="#intels-patches-on-psw-enclaves" class="hash-link" aria-label="Direct link to Intel&#x27;s patches on PSW enclaves" title="Direct link to Intel&#x27;s patches on PSW enclaves">​</a></h2>
<p>The most easy to understand example is from <code>psw/ae/pse_op/session_mgr.cpp</code>:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@@ -417,7 +461,12 @@ pse_op_error_t pse_exchange_report(uint64_t tick,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     pse_op_error_t status = OP_SUCCESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     sgx_dh_session_t sgx_dh_session;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-    sgx_key_128bit_t aek;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    // securely align aek</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    //sgx_key_128bit_t aek;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    sgx::custom_alignment_aligned&lt;sgx_key_128bit_t, sizeof(sgx_key_128bit_t), 0, sizeof(sgx_key_128bit_t)&gt; oaek;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    sgx_key_128bit_t&amp; aek = oaek.v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     sgx_dh_session_enclave_identity_t initiator_identity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     cse_sec_prop_t * pcse_sec = NULL;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     secu_info_t* psec_info = NULL;</span><br></span></code></pre></div></div>
<p>The template generates a larger struct <code>oaek</code>. Size of <code>sgx_key_128bit_t</code> is 16 bytes, and <code>sizeof(oaek)</code> equals to 32. And the offset of <code>oaek.v</code> is 8.</p>
<p>And in the same file, another fix is:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">--- a/psw/ae/pse/pse_op/session_mgr.cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+++ b/psw/ae/pse/pse_op/session_mgr.cpp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@@ -29,21 +29,65 @@</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+#include &lt;sgx_secure_align.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> #include &quot;utility.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> #include &quot;session_mgr.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> #include &quot;pse_op_t.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> #include &quot;sgx_dh.h&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> // ISV enclave &lt;-&gt; pse-op sessions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-static pse_session_t        g_session[SESSION_CONNECTION];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// securely align all ISV enclave - pse sessions&#x27; secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+static sgx::custom_alignment_aligned&lt;pse_session_t, 16, __builtin_offsetof(pse_session_t, active.AEK), 16&gt; og_session[SESSION_CONNECTION];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// following allows existing references to g_session[index]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// to not have to change</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+class CSessions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+public:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    pse_session_t&amp; operator[](int index) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+        return og_session[index].v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+static CSessions g_session;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> static uint32_t             g_session_count = 0;</span><br></span></code></pre></div></div>
<p>It seems that the original global <code>g_session</code> array is vulnerabile to INTEL-SA-00219. So Intel created a new structure <code>CSessions</code> and reloaded the <code>[]</code> operator, and used <code>custom_alignment_aligned</code> template to create the array of guarded <code>CSessions</code>.</p>
<p>We can see some more complex samples in the same file, such as:</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> // ephemeral session global variables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> static uint8_t              g_nonce_r_pse[EPH_SESSION_NONCE_SIZE] = {0};      // nonce R(PSE) for ephemeral session establishment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> static uint8_t              g_nonce_r_cse[EPH_SESSION_NONCE_SIZE] = {0};      // nonce R(CSE) for ephemeral session establishment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-static pairing_data_t       g_pairing_data;                       // unsealed pairing data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-eph_session_t               g_eph_session;                        // ephemeral session information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// securely align pairing data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// Id_pse and Id_cse aren&#x27;t secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// I don&#x27;t think pairingNonce is a secret and even if it is, we can&#x27;t align</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// all of [mk, sk, pairingID, pairingNonce]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//static pairing_data_t       g_pairing_data;                       // unsealed pairing data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+static sgx::custom_alignment&lt;pairing_data_t,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    //__builtin_offsetof(pairing_data_t, secret_data.Id_pse), sizeof(((pairing_data_t*)0)-&gt;secret_data.Id_pse),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    //__builtin_offsetof(pairing_data_t, secret_data.Id_cse), sizeof(((pairing_data_t*)0)-&gt;secret_data.Id_cse),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    __builtin_offsetof(pairing_data_t, secret_data.mk), sizeof(((pairing_data_t*)0)-&gt;secret_data.mk),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    __builtin_offsetof(pairing_data_t, secret_data.sk), sizeof(((pairing_data_t*)0)-&gt;secret_data.sk),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    __builtin_offsetof(pairing_data_t, secret_data.pairingID), sizeof(((pairing_data_t*)0)-&gt;secret_data.pairingID)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    //__builtin_offsetof(pairing_data_t, secret_data.pairingNonce), sizeof(((pairing_data_t*)0)-&gt;secret_data.pairingNonce)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    &gt; opairing_data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+pairing_data_t&amp; g_pairing_data = opairing_data.v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// securely align pse - cse/psda ephemeral session secrets</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//eph_session_t               g_eph_session;                        // ephemeral session information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+sgx::custom_alignment&lt;eph_session_t,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    __builtin_offsetof(eph_session_t, TSK), sizeof(((eph_session_t*)0)-&gt;TSK),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+    __builtin_offsetof(eph_session_t, TMK), sizeof(((eph_session_t*)0)-&gt;TMK)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+&gt; oeph_session;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// this reference trick requires change to declaration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// in other files, but still cleaner than changing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+// all references</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+eph_session_t&amp; g_eph_session = oeph_session.v;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  * @brief Check the status of the ephemeral session</span><br></span></code></pre></div></div>
<p>To understand it, let me expand <code>struct pairing_data_t</code> here:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/* Pairing blob unsealed and usable inside of enclave*/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef struct _pairing_data_t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    se_plaintext_pairing_data_t plaintext; // does not involved</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    struct se_secret_pairing_data_t {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SHA256_HASH         Id_pse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SHA256_HASH         Id_cse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SIGMA_MAC_KEY       mk;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SIGMA_SECRET_KEY    sk;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            SIGMA_SECRET_KEY    pairingID;  // old_sk used for repairing check</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Nonce128_t          pairingNonce;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            EcDsaPrivKey        VerifierPrivateKey;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } secret_data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} pairing_data_t;</span><br></span></code></pre></div></div>
<p>The patch seems to protect <code>mk</code>, <code>sk</code>, and <code>pairingID</code>, and all the other fields are commented out. What&#x27;s more, this patch uses a <strong>undocumented</strong> template <code>sgx::custom_alignment</code> defined as:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">template</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">size_t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> OLs</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> custom_alignment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> custom_alignment_aligned</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">alignof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">T</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OLs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="experiments-on-the-undocument-template">Experiments on the undocument template<a href="#experiments-on-the-undocument-template" class="hash-link" aria-label="Direct link to Experiments on the undocument template" title="Direct link to Experiments on the undocument template">​</a></h2>
<p>To test how the undocumented template work, I write the following codes:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">foo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> secret1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> sgx</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">custom_alignment</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">foo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__builtin_offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">foo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secret1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">foo</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">secret1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> AFOO</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== Size of foo = %u ===\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">foo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                               </span><span class="token comment" style="color:#999988;font-style:italic">// 40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== Size of bar = %u ===\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AFOO</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                              </span><span class="token comment" style="color:#999988;font-style:italic">// 64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== offset of AROO.v = %u ===\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__builtin_offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AFOO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== offset of secret1 = %u ===\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__builtin_offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AFOO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">secret1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 8</span><br></span></code></pre></div></div>
<p>So we can see that the structure of AROO is:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">AROO</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> _padding_head</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 0, len = 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> secret1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 8, len = 40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> _padding_tail</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 40, len = 16</span><br></span></code></pre></div></div>
<p>It seems the undocumented C++ template aligns <code>AROO</code> to the next level, and add 8-byte headings into it. If we add the second secret in <code>foo</code> like:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">foo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> secret1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> secret2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> sgx</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">custom_alignment</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">foo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">__builtin_offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">foo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secret1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">foo</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">secret1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">__builtin_offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">foo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secret2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">foo</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">secret2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> AFOO</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== Size of foo = %u ===\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">foo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 48</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== Size of bar = %u ===\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AFOO</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== offset of AROO.v = %u ===\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__builtin_offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AFOO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== offset of AROO.v.secret1 = %u ===\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__builtin_offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AFOO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">secret1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== offset of AROO.v.secret2 = %u ===\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__builtin_offsetof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">AFOO</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">secret2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 48</span><br></span></code></pre></div></div>
<p>we can see that the structure of AROO is:</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">AROO</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> _padding_head</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 0, len = 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> secret1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 8, len = 40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> secret2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 48, len = 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> _padding_tail</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// offset = 56, len = 8</span><br></span></code></pre></div></div>
<p>If we increase <code>secret2</code> to 16-bytes, it works well as usual. And the <code>_padding_tail</code> will have <strong>zero length</strong>. So does it means that <em>only extra heading is required for mitigation</em>? But it&#x27;ll not compile if we make <code>secret2</code> 24-bytes, like:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    struct foo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint64_t secret1[5];       // offset = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uint64_t secret2[3];       // offset = 40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    typedef sgx::custom_alignment&lt;foo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                __builtin_offsetof(foo, secret1), sizeof(((foo*)0)-&gt;secret1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                __builtin_offsetof(foo, secret2), sizeof(((foo*)0)-&gt;secret2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &gt; AFOO;</span><br></span></code></pre></div></div>
<p>GCC would terminate on:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make[1]: Entering directory &#x27;/root/linux-sgx/SampleCode/Cxx11SGXDemo&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">In file included from Enclave/TrustedLibrary/Libcxx.cpp:47:0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/sgxsdk/include/sgx_secure_align.h: In instantiation of &#x27;struct sgx::__custom_alignment_internal::custom_alignment&lt;ecall_lambdas_demo()::foo, 8ul, -1&gt;&#x27;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Enclave/TrustedLibrary/Libcxx.cpp:125:53:   required from here</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/sgxsdk/include/sgx_secure_align.h:123:13: error: static assertion failed: No viable offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             static_assert(LZ &gt; 0, &quot;No viable offset&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/sgxsdk/include/sgx_secure_align.h:125:48: error: size of array is negative</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             char __no_secret_allowed_in_here[LZ];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                ^</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Makefile:255: recipe for target &#x27;Enclave/TrustedLibrary/Libcxx.o&#x27; failed</span><br></span></code></pre></div></div>
<p>Nothing changes if we switch to the original template <code>sgx::custom_alignment_aligned</code>. So I guess the template does not support structures:</p>
<ul>
<li>contains secrets consecutively,  and</li>
<li>the consecutive secrets&#x27; size is larger than a certain number (not sure yet)</li>
</ul>
<p>If we break down <code>secret1</code> and <code>secret2</code> by inserting something in the middle, the template works:</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">struct foo {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint64_t secret1[5];       // offset = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  char     dumb;             // offset = 40</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint64_t secret2[3];       // offset = 48</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">typedef sgx::custom_alignment&lt;foo,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__builtin_offsetof(foo, secret1), sizeof(((foo*)0)-&gt;secret1),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">__builtin_offsetof(foo, secret2), sizeof(((foo*)0)-&gt;secret2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &gt; AFOO;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;=== Size of foo = %u ===\n&quot;, sizeof(foo));            // 72</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;=== Size of bar = %u ===\n&quot;, sizeof(AFOO));           // 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;=== offset of AROO.v = %u ===\n&quot;, __builtin_offsetof(AFOO, v));           // 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;=== offset of AROO.v.secret1 = %u ===\n&quot;, __builtin_offsetof(AFOO, v.secret1));           // 24</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">printf(&quot;=== offset of AROO.v.secret2 = %u ===\n&quot;, __builtin_offsetof(AFOO, v.secret2));           // 72</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="changesactions-required">Changes/Actions required<a href="#changesactions-required" class="hash-link" aria-label="Direct link to Changes/Actions required" title="Direct link to Changes/Actions required">​</a></h2>
<p>From Intel&#x27;s usage, we can learn that:</p>
<p>**Don&#x27;t construct a sensitive data structure directly. Always allocate an aligned structure and fill it up later **</p>
<p>It means:</p>
<ul>
<li>if you allocate something sensitive (e.g. keys in <code>sgx_key_128bit_t</code>) on stack/heap, you probably need to allocate another guarded structure first, and get a mutable reference to its inner data.</li>
<li>if you want to make <code>sgx_key_128bit_t</code> as the type of return value, you can choose between (1) return a guarded structure, or (2) takes an additional argument of caller-allocated, mutuable reference of <code>sgx_key_128bit_t</code> and fill it.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="rust-sgx-provided-primitive">Rust SGX provided primitive<a href="#rust-sgx-provided-primitive" class="hash-link" aria-label="Direct link to Rust SGX provided primitive" title="Direct link to Rust SGX provided primitive">​</a></h2>
<ul>
<li>
<p>We provided <code>AlignBox</code> as a replacement of <code>Box</code></p>
<ul>
<li>
<p><code>Box</code> is somewhat tricky because it always &quot;initialize on stack first and copy to heap later&quot;. <a href="https://github.com/kvark/copyless" target="_blank" rel="noopener noreferrer">copyless</a> provides a novel primitive to solve <a href="https://github.com/dingelish/realbox" target="_blank" rel="noopener noreferrer">it but it does not always effective</a>. To this end, we created <code>AlignBox</code> which guarantees &quot;on-heap initialization&quot; without copying any bits. Usage:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> heap_align_obj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">AlignBox</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">struct_align_t</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">heap_init_with_req</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params keyword" style="color:#00009f">mut</span><span class="token closure-params"> t</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0xf0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfa</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pad1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0xf0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfa</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pad2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0xf0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfa</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pad3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0x00</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key4 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0xf0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xf9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfa</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xfe</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0xff</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">str_slice</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property" style="color:#36acaa">assert!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">heap_align_obj</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
</li>
</ul>
</li>
<li>
<p>We provided aligned key type for each built-in key type. The layout are calculated by Intel&#x27;s template.</p>
<ul>
<li><code>sgx_align_key_128bit_t</code></li>
<li><code>sgx_align_mac_128bit_t</code></li>
<li><code>sgx_align_key_256bit_t</code></li>
<li><code>sgx_align_mac_256bit_t</code></li>
<li><code>sgx_align_ec256_dh_shared_t</code></li>
<li><code>sgx_align_ec256_private_t</code></li>
</ul>
</li>
</ul>
<p>We modified <code>sgx_tcrypto</code>, <code>sgx_tse</code>, and <code>sgx_tdh</code> and use the above primitives for enhancement, following the above required changes. One sample is from <code>sgx_tcrypto</code>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> align_mac </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">sgx_align_mac_128bit_t</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">        </span><span class="token function" style="color:#d73a49">sgx_rijndael128_cmac_msg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> sgx_cmac_128bit_key_t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">                                 src</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">as_ptr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">                                 size </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">                                 </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> align_mac</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mac </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> sgx_cmac_128bit_tag_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">+</span><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>We allocate an aligned structure first, and then fill it up using Intel&#x27;s crypto primitive later.</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/sgx-sdk-docs/everything-about-cve-2020-5499"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Everything about CVE-2020-5499</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-problem-statement-and-my-thoughts" class="table-of-contents__link toc-highlight">The problem statement and my thoughts</a></li><li><a href="#intels-new-allocator-primitive" class="table-of-contents__link toc-highlight">Intel&#39;s new allocator primitive</a></li><li><a href="#intels-patches-on-psw-enclaves" class="table-of-contents__link toc-highlight">Intel&#39;s patches on PSW enclaves</a></li><li><a href="#experiments-on-the-undocument-template" class="table-of-contents__link toc-highlight">Experiments on the undocument template</a></li><li><a href="#changesactions-required" class="table-of-contents__link toc-highlight">Changes/Actions required</a></li><li><a href="#rust-sgx-provided-primitive" class="table-of-contents__link toc-highlight">Rust SGX provided primitive</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright"><div style="font-size:.7rem; text-align:left;">Apache Teaclave™ (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF. Copyright © 2020 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache Teaclave™, Apache, the Apache feather, and the Apache Teaclave™ project logo are either trademarks or registered trademarks of the Apache Software Foundation.</div></div></div></div></footer></div>
</body>
</html>