<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Blog | Apache Teaclave™ (incubating)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://teaclave.apache.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://teaclave.apache.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://teaclave.apache.org/blog/page/2"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Apache Teaclave™ (incubating)"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="canonical" href="https://teaclave.apache.org/blog/page/2"><link data-rh="true" rel="alternate" href="https://teaclave.apache.org/blog/page/2" hreflang="en"><link data-rh="true" rel="alternate" href="https://teaclave.apache.org/blog/page/2" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://teaclave.apache.org/blog/page/2","mainEntityOfPage":"https://teaclave.apache.org/blog/page/2","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/11/30/teaclave-meetup-9","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/11/30/teaclave-meetup-9","url":"https://teaclave.apache.org/blog/2021/11/30/teaclave-meetup-9","headline":"Teaclave Meetup #9","name":"Teaclave Meetup #9","description":"Agenda","datePublished":"2021-11-30T00:00:00.000Z","author":{"@type":"Person","name":"Mingshen Sun"},"keywords":[]},{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/11/01/security-advisory-of-smashex-and-cve-2021-0186","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/11/01/security-advisory-of-smashex-and-cve-2021-0186","url":"https://teaclave.apache.org/blog/2021/11/01/security-advisory-of-smashex-and-cve-2021-0186","headline":"Security Advisory of SmashEx and CVE-2021-0186","name":"Security Advisory of SmashEx and CVE-2021-0186","description":"Recently, we were notified of a re-entrancy vulnerability in the exception","datePublished":"2021-10-25T00:00:00.000Z","author":{"@type":"Person","name":"Mingshen Sun"},"keywords":[]},{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/10/15/developing-teaclave-application-with-teaclave-trustzone-sdk","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/10/15/developing-teaclave-application-with-teaclave-trustzone-sdk","url":"https://teaclave.apache.org/blog/2021/10/15/developing-teaclave-application-with-teaclave-trustzone-sdk","headline":"使用 Teaclave TrustZone SDK 开发 TrustZone 应用","name":"使用 Teaclave TrustZone SDK 开发 TrustZone 应用","description":"[[TOC]]","datePublished":"2021-10-15T00:00:00.000Z","author":{"@type":"Person","name":"Wenwen Ruan"},"keywords":[]},{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/10/14/teaclave-meetup-8","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/10/14/teaclave-meetup-8","url":"https://teaclave.apache.org/blog/2021/10/14/teaclave-meetup-8","headline":"Teaclave Meetup #8","name":"Teaclave Meetup #8","description":"Agenda","datePublished":"2021-10-14T00:00:00.000Z","author":{"@type":"Person","name":"Mingshen Sun"},"keywords":[]},{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/10/01/announcing-teaclave-0.3.0","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/10/01/announcing-teaclave-0.3.0","url":"https://teaclave.apache.org/blog/2021/10/01/announcing-teaclave-0.3.0","headline":"Announcing Apache Teaclave™ (incubating) 0.3.0","name":"Announcing Apache Teaclave™ (incubating) 0.3.0","description":"On behalf of the Teaclave community, I am happy to announce the third Apache","datePublished":"2021-10-01T00:00:00.000Z","author":{"@type":"Person","name":"Mingshen Sun"},"keywords":[]},{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/08/26/teaclave-meetup-7","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/08/26/teaclave-meetup-7","url":"https://teaclave.apache.org/blog/2021/08/26/teaclave-meetup-7","headline":"Teaclave Meetup #7","name":"Teaclave Meetup #7","description":"In Aug 26, we gathered on Zoom for the 7th Teaclave meetup. In this meetup,","datePublished":"2021-08-26T00:00:00.000Z","author":{"@type":"Person","name":"Mingshen Sun"},"keywords":[]},{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/08/25/developing-sgx-application-with-teaclave-sgx-sdk","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/08/25/developing-sgx-application-with-teaclave-sgx-sdk","url":"https://teaclave.apache.org/blog/2021/08/25/developing-sgx-application-with-teaclave-sgx-sdk","headline":"使用 Teaclave SGX SDK 开发 SGX 应用","name":"使用 Teaclave SGX SDK 开发 SGX 应用","description":"[[TOC]]","datePublished":"2021-08-25T00:00:00.000Z","author":{"@type":"Person","name":"Wenwen Ruan"},"keywords":[]},{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/07/29/teaclave-meetup-6","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/07/29/teaclave-meetup-6","url":"https://teaclave.apache.org/blog/2021/07/29/teaclave-meetup-6","headline":"Teaclave Meetup #6","name":"Teaclave Meetup #6","description":"In July 29, we gathered on Zoom for the sixth Teaclave meetup. In the meetup, we","datePublished":"2021-07-29T00:00:00.000Z","author":{"@type":"Person","name":"Mingshen Sun"},"keywords":[]},{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/06/24/teaclave-meetup-5","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/06/24/teaclave-meetup-5","url":"https://teaclave.apache.org/blog/2021/06/24/teaclave-meetup-5","headline":"Teaclave Meetup #5","name":"Teaclave Meetup #5","description":"In Jun 24, we gathered in Zoom for the fifth monthly Teaclave meetup. In this","datePublished":"2021-06-24T00:00:00.000Z","author":{"@type":"Person","name":"Mingshen Sun"},"keywords":[]},{"@type":"BlogPosting","@id":"https://teaclave.apache.org/blog/2021/06/16/announcing-teaclave-trustzone-sdk-0.1.0","mainEntityOfPage":"https://teaclave.apache.org/blog/2021/06/16/announcing-teaclave-trustzone-sdk-0.1.0","url":"https://teaclave.apache.org/blog/2021/06/16/announcing-teaclave-trustzone-sdk-0.1.0","headline":"Announcing Apache Teaclave™ TrustZone SDK (incubating) 0.1.0","name":"Announcing Apache Teaclave™ TrustZone SDK (incubating) 0.1.0","description":"On behalf of the Teaclave community, I am happy to announce the release of","datePublished":"2021-06-16T00:00:00.000Z","author":{"@type":"Person","name":"Mingshen Sun"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Teaclave™ (incubating) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Teaclave™ (incubating) Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e2b519a3.css">
<script src="/assets/js/runtime~main.b9db7108.js" defer="defer"></script>
<script src="/assets/js/main.d9920c39.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Apache Teaclave™" class="themedComponent_mlkZ themedComponent--light_NVdE" style="height:2.5rem;max-width:300px;padding-left:1.6rem;position:relative;top:0.1rem"><img src="/img/logo.svg" alt="Apache Teaclave™" class="themedComponent_mlkZ themedComponent--dark_xIcU" style="height:2.5rem;max-width:300px;padding-left:1.6rem;position:relative;top:0.1rem"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/powered-by">Powered By</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" file="community/community.md" href="/community">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" file="community/contributing.md" href="/contributing">Contributing</a></li><li><a class="dropdown__link" file="community/contributors.md" href="/contributors">Contributors</a></li><li><a class="dropdown__link" file="community/becoming-a-member.md" href="/becoming-a-member">Becoming a Member</a></li><li><a class="dropdown__link" file="community/maturity.md" href="/maturity">Maturity Assessment</a></li><li><a class="dropdown__link" file="community/release-guide.md" href="/release-guide">Release Guide</a></li></ul></div><a class="navbar__item navbar__link" href="/download">Download</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" file="overview.md" href="/overview">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" file="teaclave-trustzone-sdk/docs/README.md" href="/trustzone-sdk-docs/">Teaclave TrustZone SDK</a></li><li><a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee_teec" target="_self" rel="" class="dropdown__link">API Docs: Teaclave TrustZone SDK (Host)<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee_utee" target="_self" rel="" class="dropdown__link">API Docs: Teaclave TrustZone SDK (TA)<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a class="dropdown__link" file="teaclave-sgx-sdk/documents/README.md" href="/sgx-sdk-docs/">Teaclave SGX SDK</a></li><li><a href="https://teaclave.apache.org/api-docs/sgx-sdk/" target="_self" rel="" class="dropdown__link">API Docs: Teaclave SGX SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a class="dropdown__link" file="teaclave-docs/README.md" href="/teaclave-docs/">Teaclave</a></li><li><a class="dropdown__link" file="teaclave-faas-legacy/docs/README.md" href="/docs/">Teaclave FaaS (legacy)</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Repos</a><ul class="dropdown__menu"><li><a href="https://github.com/apache/incubator-teaclave" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-sgx-sdk" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave SGX SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-trustzone-sdk" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave TrustZone SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-java-tee-sdk" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave Java TEE SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-website" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave Website<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">ASF Homepage<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/07/08/repo-reorg-community-focus">Teaclave Repository Restructuring and Community Focus</a></li></ul></div><div role="group"><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/12/21/teaclave-meetup-15">Teaclave Meetup #15</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/12/14/teaclave-meetup-14">Teaclave Meetup #14</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/10/08/accepting-java-enclave-proposal">Accepting JavaEnclave to Apache Teaclave™ (incubating) Proposal</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/06/29/teaclave-meetup-13">Teaclave Meetup #13</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/04/28/teaclave-meetup-12">Teaclave Meetup #12</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/04/18/announcing-teaclave-0.4.0">Announcing Apache Teaclave™ (incubating) 0.4.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/04/18/announcing-teaclave-trustzone-sdk-0.2.0">Announcing Apache Teaclave™ TrustZone SDK (incubating) 0.2.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/03/31/teaclave-meetup-11">Teaclave Meetup #11</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2022/02/24/teaclave-meetup-10">Teaclave Meetup #10</a></li></ul></div><div role="group"><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/11/30/teaclave-meetup-9">Teaclave Meetup #9</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/11/01/security-advisory-of-smashex-and-cve-2021-0186">Security Advisory of SmashEx and CVE-2021-0186</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/10/15/developing-teaclave-application-with-teaclave-trustzone-sdk">使用 Teaclave TrustZone SDK 开发 TrustZone 应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/10/14/teaclave-meetup-8">Teaclave Meetup #8</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/10/01/announcing-teaclave-0.3.0">Announcing Apache Teaclave™ (incubating) 0.3.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/08/26/teaclave-meetup-7">Teaclave Meetup #7</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/08/25/developing-sgx-application-with-teaclave-sgx-sdk">使用 Teaclave SGX SDK 开发 SGX 应用</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/07/29/teaclave-meetup-6">Teaclave Meetup #6</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/06/24/teaclave-meetup-5">Teaclave Meetup #5</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/06/16/announcing-teaclave-trustzone-sdk-0.1.0">Announcing Apache Teaclave™ TrustZone SDK (incubating) 0.1.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/06/04/accepting-rust-optee-trustzone-sdk-proposal">Accepting Rust OP-TEE TrustZone SDK to Apache Teaclave™ (incubating) Proposal</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/04/29/teaclave-meetup-4">Teaclave Meetup #4</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/03/25/teaclave-meetup-3">Teaclave Meetup #3</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/03/15/welcome-rust-optee-trustzone-sdk-cn">欢迎 Rust OP-TEE TrustZone SDK 成为 Teaclave 子项目</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/03/15/welcome-rust-optee-trustzone-sdk">Welcome Rust OP-TEE TrustZone SDK to Teaclave</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/03/02/announcing-teaclave-0.2.0-cn">Apache Teaclave™ (incubating) 0.2.0 发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/03/02/announcing-teaclave-0.2.0">Announcing Apache Teaclave™ (incubating) 0.2.0</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/02/25/teaclave-meetup-2">Teaclave Meetup #2</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/01/28/teaclave-meetup-1">Teaclave Meetup #1</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2021/01/20/roadmap-in-2021-project-maturity-and-community-buildup">Roadmap in 2021: Project Maturity and Community Buildup</a></li></ul></div><div role="group"><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/12/09/teaclave-ecosystem">The Teaclave Secure Computing Ecosystem - Projects Powered by Teaclave</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/12/04/teaclave-ecosystem-cn">Teaclave 安全计算开源生态 - 由 Teaclave 驱动的开源项目一览</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/10/29/announcing-teaclave-0.1.0-cn">让安全计算更简单 - Apache Teaclave™ (incubating) 0.1.0 正式发布</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2020/10/22/announcing-teaclave-0.1.0">Announcing Apache Teaclave™ (incubating) 0.1.0</a></li></ul></div><div role="group"><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2019/12/03/mitigation-of-intel-sa-00219-in-teaclave-sgx-sdk">Mitigation of Intel-SA-00219 in Teaclave SGX SDK</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2019/08/20/apache-incubation-proposal">Aapache Incubation Proposal</a></li></ul></div></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/11/30/teaclave-meetup-9">Teaclave Meetup #9</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-11-30T00:00:00.000Z">November 30, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Mingshen Sun</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="agenda">Agenda<a href="#agenda" class="hash-link" aria-label="Direct link to Agenda" title="Direct link to Agenda">​</a></h2>
<ul>
<li>SmashEx: Smashing SGX Enclaves Using Exceptions — Jinhua Cui</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<ul>
<li><em>SmashEx: Smashing SGX Enclaves Using Exceptions</em> (CCS 2021):
Jinhua Cui (National University of Defense Technology, National University of
Singapore); Zhijingcheng Yu (National University of Singapore); Shweta Shinde
(ETH Zurich); Prateek Saxena (National University of Singapore); Zhiping Cai
(National University of Defense Technology)</li>
<li><a href="https://arxiv.org/ftp/arxiv/papers/2110/2110.06657.pdf" target="_blank" rel="noopener noreferrer">https://arxiv.org/ftp/arxiv/papers/2110/2110.06657.pdf</a></li>
<li>CVE-2021-0186
<ul>
<li><a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00548.html" target="_blank" rel="noopener noreferrer">https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00548.html</a></li>
<li><strong>Description</strong>: Improper input validation in the Intel(R) SGX SDK
applications compiled for SGX2 enabled processors may allow a privileged
user to potentially escalation of privilege via local access.</li>
<li><strong>Affected Products</strong>: Intel SGX SDK for Windows v2.12 and earlier, Intel
SGX SDK for Linux v2.13 and earlier, Intel® Processors supporting SGX2.</li>
<li>Intel recommends updating the Intel® SGX SDK to the versions listed below.
Enclaves built with the new Intel® SGX SDK version should increment the
value of their ISVSVN field.</li>
</ul>
</li>
<li>Patch: <a href="https://github.com/intel/linux-sgx/commit/edfe42a517b3e4b1d81204c3cdef6da6cb35fefc" target="_blank" rel="noopener noreferrer">https://github.com/intel/linux-sgx/commit/edfe42a517b3e4b1d81204c3cdef6da6cb35fefc</a></li>
<li><a href="https://teaclave.apache.org/blog/2021-10-25-security-advisory-of-smashex-and-cve-2021-0186/" target="_blank" rel="noopener noreferrer">Security Advisory from the Teaclave Community</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="attendees">Attendees<a href="#attendees" class="hash-link" aria-label="Direct link to Attendees" title="Direct link to Attendees">​</a></h2>
<ul>
<li>Jinghua</li>
<li>Ran Duan</li>
<li>Rong Fan</li>
<li>Gordon</li>
<li>He Sun</li>
<li>Hongbo Chen</li>
<li>Jason Yu</li>
<li>Pei Wang</li>
<li>ruanwenwen</li>
<li>Rundong</li>
<li>Tongxin Li</li>
<li>Weijie Liu</li>
<li>Yuan Zhuang</li>
<li>Zha0Chan</li>
<li>Mingshen Sun</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="group-photo">Group Photo<a href="#group-photo" class="hash-link" aria-label="Direct link to Group Photo" title="Direct link to Group Photo">​</a></h2>
<p><img decoding="async" loading="lazy" alt="Group Photo" src="/assets/images/teaclave-meetup-9-zoom-44f7cab836413763990b7bd2543585f5.png" width="3808" height="2414" class="img_ev3q"></p></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/11/01/security-advisory-of-smashex-and-cve-2021-0186">Security Advisory of SmashEx and CVE-2021-0186</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-10-25T00:00:00.000Z">October 25, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Mingshen Sun</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>Recently, we were notified of a re-entrancy vulnerability in the exception
handling designs of some popular SGX SDKs (including Intel SGX SDK), resulting in
arbitrary disclosure of enclave private memory and code-reuse attacks in SGX
enclave.</p>
<p>The vulnerability is named as <a href="https://jasonyu1996.github.io/SmashEx/" target="_blank" rel="noopener noreferrer">SmashEx</a>
[1]. The SmashEx attack affects several SGX runtimes with exception handling.
For Intel SGX SDK, the assigned identifier is
<a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00548.html" target="_blank" rel="noopener noreferrer">CVE-2021-0186</a> [2].
While the vulnerability itself is not a Teaclave flaw, we&#x27;re taking proactive
measures to explain and mitigate its impact on Teaclave users.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Due to the lack of atomicity primitives in SGX enclaves, an SGX enclave can be
interrupted and re-entered at any time, including when it is in a state unsafe
for re-entry (i.e., when it is executing a critical section). The SmashEx attack
exploits such unsafe enclave re-entries happening in the exception handling
mechanism in the SGX runtime.</p>
<p>A malicious host can create an exception immediately after EENTER which causes
control to be transferred to the host before the enclave stack (RSP register)
has been properly set up. Then, a special ECALL (called <code>ECMD_EXCEPT</code>) to
enclave will use the attacker-controlled RSP register to setup the context of
the exception handler function. At last, when the host transfers control back to the
enclave with ERESUME, it may execute with a stack that resides in host memory
thereby enabling ROP exploits.</p>
<p>This vulnerability can be fixed by adding extra checks on untrusted RSP when
constructing the context of the exception handler.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="affected-versions">Affected Versions<a href="#affected-versions" class="hash-link" aria-label="Direct link to Affected Versions" title="Direct link to Affected Versions">​</a></h2>
<p>For Intel SGX SDK, the vulnerability affects all projects using the following
versions.</p>
<ul>
<li>Intel SGX SDK for Windows v2.12 and erlier</li>
<li>Intel SGX SDK for Linux v2.13 and earlier</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="impacts-on-teaclave">Impacts on Teaclave<a href="#impacts-on-teaclave" class="hash-link" aria-label="Direct link to Impacts on Teaclave" title="Direct link to Impacts on Teaclave">​</a></h2>
<p>Teaclave SGX SDK wraps Intel SGX SDK and provides a Rust development
environment. The affected Intel SGX SDK version was recommended in Rust SGX SDK
v1.1.3 (which is a pre-Apache release). Therefore, people using Rust SGX SDK
v1.1.3 with the vulnerable Intel SGX SDK (v2.13 and earlier) are also
vulnerable. <em>However, the current Teaclave SGX SDK is compatible with newer Intel SGX
SDK versions. Therefore, we recommend all users to upgrade to the latest Intel
SGX SDK.</em></p>
<p>For Teaclave (i.e., the Teaclave FaaS platform), it uses Teaclave SGX SDK to
build a confidential computing platform. Therefore, the Teaclave v0.2.0 released
in March used the vulnerable Intel SGX SDK version.
<em>However, the <a href="https://github.com/apache/incubator-teaclave/releases/tag/v0.3.0" target="_blank" rel="noopener noreferrer">v0.3.0 released</a> [3]
in August has upgraded the Intel SGX SDK to v2.14 with the fix. Therefore,
the latest release of Teaclave is not affected by this vulnerability.</em></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="patches--mitigations">Patches &amp; Mitigations<a href="#patches--mitigations" class="hash-link" aria-label="Direct link to Patches &amp; Mitigations" title="Direct link to Patches &amp; Mitigations">​</a></h2>
<p>The vulnerability has been fixed in Intel SGX SDK in this patch:</p>
<ul>
<li>Patch: <a href="https://github.com/intel/linux-sgx/commit/edfe42a517b3e4b1d81204c3cdef6da6cb35fefc" target="_blank" rel="noopener noreferrer">https://github.com/intel/linux-sgx/commit/edfe42a517b3e4b1d81204c3cdef6da6cb35fefc</a></li>
</ul>
<p>Teaclave users can apply the following mitigations:</p>
<ul>
<li>Use Teacalve SGX SDK with Intel SGX SDK for Linux version 2.14 or later</li>
<li>Upgrade to Teaclave 0.3.0 or later</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="acknowledgements">Acknowledgements<a href="#acknowledgements" class="hash-link" aria-label="Direct link to Acknowledgements" title="Direct link to Acknowledgements">​</a></h2>
<p>We would like to thank Jinhua Cui, National University of Defense Technology and
National University of Singapore, Shweta Shinde, ETH Zurich , Zhijingcheng Yu,
National University of Singapore, and Prateek Saxena, National University of
Singapore for notifying us about this issue.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2>
<ul>
<li>[1] <a href="https://jasonyu1996.github.io/SmashEx/" target="_blank" rel="noopener noreferrer">https://jasonyu1996.github.io/SmashEx/</a></li>
<li>[2] <a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00548.html" target="_blank" rel="noopener noreferrer">https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00548.html</a></li>
<li>[3] <a href="https://github.com/apache/incubator-teaclave/releases/tag/v0.3.0" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-teaclave/releases/tag/v0.3.0</a></li>
<li><a href="https://arxiv.org/abs/2110.06657" target="_blank" rel="noopener noreferrer">SmashEx: Smashing SGX Enclaves Using Exceptions</a></li>
<li><a href="https://github.com/openenclave/openenclave/security/advisories/GHSA-mj87-466f-jq42" target="_blank" rel="noopener noreferrer">Open Enclave SDK Elevation of Privilege Vulnerability</a></li>
</ul></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/10/15/developing-teaclave-application-with-teaclave-trustzone-sdk">使用 Teaclave TrustZone SDK 开发 TrustZone 应用</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-10-15T00:00:00.000Z">October 15, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Wenwen Ruan</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>[[TOC]]</p>
<p>在 <a href="https://teaclave.apache.org/blog/2021-03-15-welcome-rust-optee-trustzone-sdk-cn/" target="_blank" rel="noopener noreferrer">欢迎 RUST OP-TEE TRUSTZONE SDK 成为 TEACLAVE 子项目</a> 一文中已经对Teaclave TrustZone SDK 项目进行了简单的介绍。在本文中，将会介绍使用 Teaclave TrustZone SDK 开发 TrustZone 应用程序。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="teaclave-trustzone-sdk-应用开发环境搭建">Teaclave TrustZone SDK 应用开发环境搭建<a href="#teaclave-trustzone-sdk-应用开发环境搭建" class="hash-link" aria-label="Direct link to Teaclave TrustZone SDK 应用开发环境搭建" title="Direct link to Teaclave TrustZone SDK 应用开发环境搭建">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="准备条件">准备条件<a href="#准备条件" class="hash-link" aria-label="Direct link to 准备条件" title="Direct link to 准备条件">​</a></h3>
<ul>
<li>Ubuntu 系列</li>
</ul>
<p><em>本文基于的 Teaclave TrustZone SDK 提交哈希值：8520a2018705edcebfb7e729bd2ced12414fc052</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-teaclave-trustzone-sdk-编译环境">配置 Teaclave TrustZone SDK 编译环境<a href="#配置-teaclave-trustzone-sdk-编译环境" class="hash-link" aria-label="Direct link to 配置 Teaclave TrustZone SDK 编译环境" title="Direct link to 配置 Teaclave TrustZone SDK 编译环境">​</a></h3>
<p>下载 Teaclave TrustZone SDK 项目，初始化相关的子模块并安装 Rust 工具链以及交叉编译工具 Xargo。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git clone https://github.com/apache/incubator-teaclave-trustzone-sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cd incubator-teaclave-trustzone-sdk</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./setup.sh</span><br></span></code></pre></div></div>
<p>初始化 OP-TEE 子模块。初始化完毕之后，在 <code>optee</code> 根目录下需要有 <code>build/</code>, <code>optee_os/</code> 和 <code>optee_client</code> 子目录。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git submodule update --init -- optee</span><br></span></code></pre></div></div>
<p>在编译样例之前，需要设置环境变量。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ source environment</span><br></span></code></pre></div></div>
<p>默认情况下，目标平台是 <code>aarch64</code>，如果希望为 <code>arm</code> 平台编译，需要在 <code>source environment</code> 之前设置 <code>ARCH</code> 变量。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ export ARCH=arm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ source environment</span><br></span></code></pre></div></div>
<p>接着，下载 ARM 工具链并编译 OP-TEE 库。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make optee</span><br></span></code></pre></div></div>
<p>最后，编译 Teaclave TrustZone SDK 官方提供的例子。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make examples</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="在-qemu-armv8-上运行-teaclave-trustzone-sdk-应用程序">在 QEMU ARMv8 上运行 Teaclave TrustZone SDK 应用程序<a href="#在-qemu-armv8-上运行-teaclave-trustzone-sdk-应用程序" class="hash-link" aria-label="Direct link to 在 QEMU ARMv8 上运行 Teaclave TrustZone SDK 应用程序" title="Direct link to 在 QEMU ARMv8 上运行 Teaclave TrustZone SDK 应用程序">​</a></h3>
<p>现在，Teaclave TrustZone SDK 官方提供的示例已经编译好了，但如果需要在 QEMU ARMv8 模拟器上运行这些示例，还需要准备一个支持 OP-TEE 的 QEMU 环境，从而在该环境上运行已经编译好的 SDK 中的示例。
首先，需要安装 QEMU 环境需要的依赖。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo apt-get install android-tools-adb android-tools-fastboot autoconf \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        automake bc bison build-essential ccache cscope curl device-tree-compiler \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        expect flex ftp-upload gdisk iasl libattr1-dev libc6:i386 libcap-dev \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        libfdt-dev libftdi-dev libglib2.0-dev libhidapi-dev libncurses5-dev \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        libpixman-1-dev libssl-dev libstdc++6:i386 libtool libz1:i386 make \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mtools netcat python-crypto python3-crypto python-pyelftools \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        python3-pycryptodome python3-pyelftools python-serial python3-serial \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rsync unzip uuid-dev xdg-utils xterm xz-utils zlib1g-dev</span><br></span></code></pre></div></div>
<p>也可以选择使用 Teaclave TrustZone SDK 官方提供的 docker，在 docker 中开发就无需下载上述依赖。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker pull teaclave/teaclave-trustzone-sdk-build:0.2.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># start docker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run -ti teaclave/teaclave-trustzone-sdk-build:0.2.1</span><br></span></code></pre></div></div>
<p>下载 QEMU ARMv8 对应的 OP-TEE 的源代码。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir -p ~/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ curl https://storage.googleapis.com/git-repo-downloads/repo-1 &gt; ~/bin/repo &amp;&amp; chmod a+x ~/bin/repo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ export PATH=~/bin:$PATH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir optee-qemuv8-3.14.0 &amp;&amp; cd optee-qemuv8-3.14.0 &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repo init -u https://github.com/OP-TEE/manifest.git -m qemu_v8.xml -b 3.14.0 &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repo sync -j4 --no-clone-bundle</span><br></span></code></pre></div></div>
<p>编译 QEMU ARMv8 OP-TEE。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd build</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ make -j2 toolchains &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  make QEMU_VIRTFS_ENABLE=y CFG_TEE_RAM_VA_SIZE=0x00300000</span><br></span></code></pre></div></div>
<p>在漫长的编译过程之后，还需要新建一个共享文件夹，用于和 QEMU 子系统共享示例的 host apps 和 TAs。</p>
<p>首先要将 <code>path/to/example/host/target/aarch64-unknown-linux-gnu/release/example</code> 和 <code>path/to/example/ta/target/aarch64-unknown-optee-trustzone/release/*.ta</code> 分别复制到 <code>incubator-teaclave-trustzone-sdk/out/host</code> 和 <code>incubator-teaclave-trustzone-sdk/out/ta/</code>。接着还需要将 <code>incubator-teaclave-trustzone-sdk/out/*</code> 中的文件复制到 QEMU 共享文件夹 <code>shared_folder/</code> 中。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir shared_folder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ (cd /project/root/dir/ &amp;&amp; make examples-install)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cp -r /project/root/dir/out/* shared_folder/</span><br></span></code></pre></div></div>
<p>如果处于一个没有 GUI 的运行环境，在启动 QEMU 之前，还需要修改 <code>qemu_v8.mk</code> 中的代码。以 OP-TEE QEMU 3.14.0 版本为例，注释掉 <code>optee-qemuv8-3.14.0/build/qemu_v8.mk</code> 中的 386-388 行。</p>
<div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">.PHONY: run-only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">run-only:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ln -sf $(ROOT)/out-br/images/rootfs.cpio.gz $(BINARIES_PATH)/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $(call check-terminal)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $(call run-help)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # $(call launch-terminal,54320,&quot;Normal World&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # $(call launch-terminal,54321,&quot;Secure World&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # $(call wait-for-ports,54320,54321)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cd $(BINARIES_PATH) &amp;&amp; $(QEMU_BUILD)/aarch64-softmmu/qemu-system-aarch64 \</span><br></span></code></pre></div></div>
<p>在启动 QEMU 之前前，需要运行 <code>nc</code> 来监听端口 <code>54320</code> 和 <code>54321</code>。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ nc -l 127.0.0.1 -p 54320</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ nc -l 127.0.0.1 -p 54321</span><br></span></code></pre></div></div>
<p>进入 <code>qemu_v8.mk</code> 所在的目录启动 QEMU。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">make run-only QEMU_VIRTFS_ENABLE=y QEMU_VIRTFS_HOST_DIR=$(pwd)/shared_folder</span><br></span></code></pre></div></div>
<p>当 QEMU 启动之后，端口 <code>54320</code> 窗口中运行的是普通世界，端口 <code>54321</code> 窗口中运行的是安全世界。在普通世界中，根据提示输入 <code>root</code> 登录后，需要将共享文件夹挂载到 QEMU 子系统中，用于在 QEMU 中访问编译好的 CA/TA 可执行文件。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ mkdir shared &amp;&amp; mount -t 9p -o trans=virtio host shared</span><br></span></code></pre></div></div>
<p>接着，需要将 TA 复制到 <code>/lib/optee_armtz</code> 目录下，提供给安全世界调用。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd shared &amp;&amp; cp ta/*.ta /lib/optee_armtz/</span><br></span></code></pre></div></div>
<p>进入 <code>host</code> 文件夹中并执行 host apps。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ./hello_world</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">original value is 29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inc value is 129</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dec value is 29</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><br></span></code></pre></div></div>
<p>至此，我们成功地在 QEMU 环境中运行了 Teaclave TrustZone SDK 的 <code>hello_world-rs</code> 示例。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-teaclave-trustzone-sdk-应用程序的-debug-环境">配置 Teaclave TrustZone SDK 应用程序的 debug 环境<a href="#配置-teaclave-trustzone-sdk-应用程序的-debug-环境" class="hash-link" aria-label="Direct link to 配置 Teaclave TrustZone SDK 应用程序的 debug 环境" title="Direct link to 配置 Teaclave TrustZone SDK 应用程序的 debug 环境">​</a></h3>
<p>在开发应用程序的时候，难免会有 debug 的需求，在这不一部分，将会简单介绍如何在 Teaclave TrustZone SDK 中配置 debug 环境。</p>
<p>在编译 QEMU ARMv8 OPTEE 时需要关闭 ASLR，可以通过直接修改 <code>OP-TEE/optee_os/mk/config.mk</code> 文件中的 <code>CFG_CORE_ASLR</code> 为 <code>n</code>，注意修改之后还需要重新编译 <code>make run</code>。</p>
<div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># CFG_CORE_ASLR ?= y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CFG_CORE_ASLR ?= n</span><br></span></code></pre></div></div>
<p>也可以直接在编译时添加编译信息： <code>make run CFG_CORE_ASLR=n</code>。</p>
<p>由于程序是在远程系统上 (QEMU) 上被 debugged，所以在编译时还需要加上 <code>GDBSERVER=y</code>。</p>
<p>在启动 gdb 之后，执行 <code>target remote :1234</code> 命令连接上 QEMU GDB 服务器端口。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ ./path/to/qemu-v8-project/out-br/host/bin/aarch64-buildroot-linux-gnu-gdb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) target remote :1234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Remote debugging using :1234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">warning: No executable has been specified and target does not support</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">determining executable automatically.  Try using the &quot;file&quot; command.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xffffb30b00ea12b4 in ?? ()</span><br></span></code></pre></div></div>
<p>接下来，加载 TEE 内核符号表。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) symbol-file /path/to/qemu-v8-project/optee_os/out/arm/core/tee.elf</span><br></span></code></pre></div></div>
<p>以 <code>hello_world-rs</code> 为例，根据安全世界窗口提示，可知 <code>hello_world-rs</code> 的 TA text 部分的起始地址为 0x40014000。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">D/LD:  ldelf:168 ELF (133af0ca-bdab-11eb-9130-43bf7873bf67) at 0x40014000</span><br></span></code></pre></div></div>
<p>根据该地址提示，从该地址开始加载 <code>hello_world-rs</code> 的 ta 符号表。</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) add-symbol-file /path/to/examples/hello_world-rs/ta/target/aarch64-unknown-optee-trustzone/debug/ta 0x40014000</span><br></span></code></pre></div></div>
<p>然后，可以根据自己的需求在相应的函数或地址上打断点。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">(gdb) b open_session</span><br></span></code></pre></div></div>
<p><img decoding="async" loading="lazy" alt="QEMU 执行示意图" src="/assets/images/2021-10-15-qemu-world-execution-windows-6ac2c359fde49aa8310143bb005c6553.png" width="1900" height="1064" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="teaclave-trustzone-sdk-示例-hello_world-rs-剖析">Teaclave TrustZone SDK 示例 hello_world-rs 剖析<a href="#teaclave-trustzone-sdk-示例-hello_world-rs-剖析" class="hash-link" aria-label="Direct link to Teaclave TrustZone SDK 示例 hello_world-rs 剖析" title="Direct link to Teaclave TrustZone SDK 示例 hello_world-rs 剖析">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hello_world-rs-目录结构"><code>hello_world-rs</code> 目录结构<a href="#hello_world-rs-目录结构" class="hash-link" aria-label="Direct link to hello_world-rs-目录结构" title="Direct link to hello_world-rs-目录结构">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── main.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── build.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── lib.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Xargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── build.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── main.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── ta_aarch64.lds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── ta_arm.lds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── ta_static.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── uuid.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ul>
<li><code>host</code> 文件夹中存放的是普通世界的 <code>untrusted code</code>。
<ul>
<li><code>host/src/main.rs</code> 是 <code>hello_world-rs</code> 应用程序执行的入口，<code>Cargo.toml</code> 描述了 <code>host</code> 部分的依赖， <code>Cargo.lock</code> 中包含了依赖项的完整信息，<code>Makefile</code> 定义了 <code>host</code> 部分的编译信息。</li>
</ul>
</li>
<li><code>ta</code> 文件夹中存放的是安全世界中的 <code>trusted code</code>。
<ul>
<li>相比较 <code>host</code>，<code>ta</code> 文件夹中多了以下文件：<code>Xargo.toml</code> 是 TA 的交叉编译文件 ，<code>ta_aarch64.lds</code> 和 <code>ta_arm.lds</code> 分别定义了在 64 位架构和 32 位架构下 teaclave trustzone sdk 应用程序各部分在程序地址空间内的布局；<code>ta_static.rs</code> 定义了 TA 中的静态数据信息。</li>
</ul>
</li>
<li><code>proto</code> 文件夹中存放的是 CA (Client Application) 和 TA (Trusted Application) 共享的数据结构，并承担着解析 <code>uuid.txt</code> 提取 UUID 的任务。</li>
<li><code>uuid.txt</code> 文件中记录的是 TA 的 UUID，是每个 TA 独一无二的身份标识。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hello_world-rs-重要代码文件解析"><code>hello_world-rs</code> 重要代码文件解析<a href="#hello_world-rs-重要代码文件解析" class="hash-link" aria-label="Direct link to hello_world-rs-重要代码文件解析" title="Direct link to hello_world-rs-重要代码文件解析">​</a></h3>
<ul>
<li><code>host/src/main.rs</code></li>
</ul>
<p>进入 <code>main</code> 函数，首先调用 <code>Context::new</code> 函数建立起 <code>hello_world-rs</code> CA 和 TA 的逻辑联系，<code>ctx</code> 指向类型为 <code>Context</code> 的变量的地址，用于 CA 和 TA 的连接和通信。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Context</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>调用 <code>open_session</code> 在 CA 和对应的 TA 中打开一个 <code>session</code>，并将 <code>hello_world-rs</code> 的 UUID 作为参数传入，用于指引 CA 连接对应 UUID 值的 TA。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> uuid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Uuid</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">parse_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">UUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> session </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">open_session</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uuid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>将 <code>&amp;mut session</code> 作为参数传入 <code>hello_world</code> 函数中。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">hello_world</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>进入到 <code>hello_world</code> 函数中，首先将要进行运算的 <code>u32</code> 操作数用 <code>ParamValue</code> 类型包装为操作数 <code>p0</code>，设置其值为29，类型为 <code>ValueInout</code>，表示同时作为输入参数和返回值。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> p0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ParamValue</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">29</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ParamType</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">ValueInout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p><code>operation</code> 用于保存 CA 要传递给 TA 的参数信息，第一个参数一般保留为 0，由于这里只有一个要传递的参数 <code>p0</code>，其他参数都保留为 <code>ParamNone</code>。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> operation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Operation</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ParamNone</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ParamNone</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ParamNone</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>CA 端使用获取到的 <code>session</code>, <code>command_id</code> 和要传递的参数 <code>operation</code> 调用 <code>invoke_command</code> 执行特定的 <code>command</code>，该操作将会切换到安全世界。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke_command</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">IncValue</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<ul>
<li><code>ta/src/main.rs</code></li>
</ul>
<p><code>ta/src/main.rs</code> 中的 <code>invoke_command</code> 函数参数与 host 中调用的 <code>invoke_command</code> 略有不同，第二个参数是 <code>Paramters</code> 类型。当数据从 CA 传递到 TA 时，实际上执行的是按 bit 的复制操作，所以 <code>params</code> 中的数据就是从 <code>operation</code> 中传递过来的数据.</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">invoke_command</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmd_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Parameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><br></span></code></pre></div></div>
<p><code>values</code> 从 <code>params</code> 取出要操作的 <code>u32</code> 值，<code>match</code> 表达式根据传入的参数 <code>cmd_id</code> 匹配对应的操作。在下面的代码中，如果匹配到 <code>Command::IncValue</code>，就对 <code>values</code> 中的 <code>u32</code> 值执行 +100 的操作；如果匹配到 <code>Command::DecValue</code>，就执行 -100 的操作；如果匹配到其他值，就直接返回错误参数的错误类型。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">invoke_command</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmd_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Parameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">trace_println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;[+] TA invoke command&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> params</span><span class="token number" style="color:#36acaa">.0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">as_value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> </span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmd_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">IncValue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_a</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">a</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">DecValue</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_a</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">values</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">a</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Error</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">ErrorKind</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">BadParameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<ul>
<li><code>proto/src/lib.rs</code></li>
</ul>
<p><code>lib.rs</code> 中的枚举变量 <code>Command</code> 声明是开发者要实现的命令。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Command</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">IncValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">DecValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Unknown</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="编译之后的-hello_world-rs-代码目录">编译之后的 <code>hello_world-rs</code> 代码目录<a href="#编译之后的-hello_world-rs-代码目录" class="hash-link" aria-label="Direct link to 编译之后的-hello_world-rs-代码目录" title="Direct link to 编译之后的-hello_world-rs-代码目录">​</a></h3>
<p>编译之后的代码目录如下所示，这里省略了 <code>release</code> 文件夹下的内容。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── main.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── target                               #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├── aarch64-unknown-linux-gnu        #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       │   └── release                      #[generate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── release                          #[generate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── build.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── lib.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── target                               #[generate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── rls                              #[generate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           └── debug                        #[generate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.lock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Xargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── build.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── main.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── ta_aarch64.lds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── ta_arm.lds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── ta_static.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── target                               #[generate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├── aarch64-unknown-optee-trustzone  #[generate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       │   └── release                      #[generate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── release                          #[generate]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── uuid.txt</span><br></span></code></pre></div></div>
<p><code>hello_world-rs</code> 编译过程更类似于 Rust 程序编译。</p>
<ul>
<li>编译不可信部分 host 文件夹，生成 <code>hello_world-rs</code> 可执行文件；</li>
<li>交叉编译可信部分 ta 文件夹，再用 UUID 和密钥进行签名，生成 <code>UUID.ta</code> 可执行文件。</li>
<li>在执行时，<code>hello_world-rs</code> 对 <code>UUID.ta</code> 验证通过后调用执行。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="开发者如何开发自己的-teaclave-trustzone-sdk-应用程序">开发者如何开发自己的 Teaclave TrustZone SDK 应用程序<a href="#开发者如何开发自己的-teaclave-trustzone-sdk-应用程序" class="hash-link" aria-label="Direct link to 开发者如何开发自己的 Teaclave TrustZone SDK 应用程序" title="Direct link to 开发者如何开发自己的 Teaclave TrustZone SDK 应用程序">​</a></h2>
<p>和前面介绍过的 <a href="https://teaclave.apache.org/blog/2021-08-25-developing-sgx-application-with-teaclave-sgx-sdk/" target="_blank" rel="noopener noreferrer">使用 TEACLAVE SGX SDK 开发 SGX 应用</a> 相似，这里也同样通过对 Teaclave TrustZone SDK 示例程序 <code>hello_world-rs</code> 进行改写来介绍如何构造自己的 Teaclave TrustZone SDK。</p>
<p>需要注意的是，Teaclave TrustZone SDK 是通过 UUID 唯一标识系统中的 TA，UUID 值不能重复，所以我们首先需要通过 <a href="https://www.itu.int/en/ITU-T/asn1/Pages/UUID/uuids.aspx" target="_blank" rel="noopener noreferrer">ITU-T UUID generator</a> 网站申请属于自己的唯一的 UUID，并将 <code>uuid.rs</code> 文件中的内容修改为新得到的 UUID 值。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1487a406-160d-4641-957e-66292f8d1309</span><br></span></code></pre></div></div>
<p>假设开发目标是为两个 <code>u8</code> 数组求得交集和并集，也就是要实现交集函数 <code>Intersection</code> 和并集函数 <code>Union</code> 两个功能函数。</p>
<p>对 <code>proto/lib.rs</code> 进行修改，将 <code>Command</code> 中的成员替换为待实现的 <code>Intersection</code> 和 <code>Union</code>。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Command</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Intersection</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Union</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Unknown</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">From</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">Command</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[inline]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Command</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> value </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Intersection</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Union</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _ </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Unknown</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>接着，进入 <code>host/src/main.rs</code> 中的 <code>main</code> 函数，添加进行数据计算的函数，将用于与 TA 通信的 session 内存地址作为参数传递到 <code>data_compute</code> 中。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">data_compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>在 <code>data_compute</code> 中，首先声明要进行数据处理的两个 <code>u8</code> 数组 <code>nums1</code> 和 <code>nums2</code>，以及用于存储数据处理结果的 <code>resu</code>。在示例代码 <code>hello_world</code> 中的变量声明使用的是 <code>ParamValue</code>，但这里我们需要访问数组，一段连续的内存变量而非变量。通过阅读 Teaclave TrustZone SDK client 端的 Rust 仓库 <a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee-teec/optee_teec/index.html" target="_blank" rel="noopener noreferrer">Crate optee_teec</a>，可知 <code>ParamTmpRef</code> 用于定义临时内存访问。于是将这三个数组地址作为参数新建 <code>ParamTmpRef</code> 类型，并将 <code>ParamTmpRef</code> 类型变量传递到 <code>operation</code> 中，用于传递给 TA 交互信息。</p>
<p>在准备好与 TA 交互的信息后，调用 <code>invoke_command</code> 通知对应的 TA 执行 <code>Command::Intersection</code> 指定的操作。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// in host/src/main.rs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">data_compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">session</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token class-name">Session</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">optee_teec</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> nums1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> nums2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> resu </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">vec!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> p1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ParamTmpRef</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new_input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> p2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ParamTmpRef</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new_input</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> p3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ParamTmpRef</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new_output</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> resu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> operation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Operation</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ParamNone</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;intersection invoke&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    session</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">invoke_command</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Intersection</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> operation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><code>invoke_command</code> 函数的具体实现在 <code>ta/sec/main.rs</code> 文件中的 <code>invoke_command</code>。共享的参数通过 <code>params</code> 从 CA 传递到 TA 中，
同样，可以根据 TA 端的 Rust 仓库 <a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee-utee/optee_utee/index.html" target="_blank" rel="noopener noreferrer">optee_utee</a> 提供的接口函数抽丝剥茧般地提取出来 <code>ParamMemref</code> 类型的 <code>nums1</code>, <code>nums2</code> 和 <code>vec_resu</code>。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> nums1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> params</span><span class="token number" style="color:#36acaa">.0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">as_memref</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> nums2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> params</span><span class="token number" style="color:#36acaa">.1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">as_memref</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> vec_resu </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> params</span><span class="token number" style="color:#36acaa">.2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">as_memref</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">unwrap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> nums1_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> nums2_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>现在，进入 <code>match</code> 表达式中，将 <code>Command::from</code> 的枚举修改为 <code>Command::Intersection</code> 和 <code>Command::Union</code>。要实现的函数就填充到对应的分支括号中。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> </span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmd_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Intersection</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Command</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Union</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>下面的示例代码实现的是求两个数组之间的交集元素。具体的实现是通过一个额外的散列集 <code>set</code>，记录 <code>nums1</code> 中的所有元素，然后对 <code>nums2</code> 中的元素进行遍历，如果 <code>nums2</code> 中的元素也出现在了 <code>set</code> 中，那么该元素为 <code>nums1</code> 和 <code>nums2</code> 共有，是交集元素，写入结果向量 <code>vec_resu</code> 中，并移除掉 <code>set</code> 中的该元素。最后，将结果向量的 <code>size</code> 修改为共有的交集元素的个数。其中，要读取 <code>nums1</code> 和 <code>nums2</code> 数组中的元素，还需要解引用 <code>ParamMemref</code> 类型的指针读取出指向元素值的 <code>buffer</code> 指针地址，再使用 <code>offset</code> 偏移指针从而读出 <code>nums1</code> 和 <code>nums2</code> 的值。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> set</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">HashSet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HashSet</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> vec_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">nums1_size </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> val_nums1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          val_nums1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">isize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val_nums1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">nums2_size </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> val_nums2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          val_nums2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">isize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">val_nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vec_resu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vec_count </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">isize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val_nums2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          vec_count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">val_nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vec_resu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vec_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>对于 <code>Union</code> 函数的实现，同样是利用一个额外的散列集 <code>set</code>，记录 <code>nums1</code> 中的所有元素，并直接将 <code>nums1</code> 中的元素写入结果向量 <code>vec_resu</code> 中，而后再依次读取 <code>nums2</code> 中的元素，如果该元素没有在 <code>set</code> 中出现，则写入结果向量 <code>vec_resu</code> 和散列集 <code>set</code> 中。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> set</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">HashSet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HashSet</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> vec_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">nums1_size </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> val_nums1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          val_nums1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">isize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vec_resu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vec_count </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">isize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val_nums1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vec_count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val_nums1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">nums2_size </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> val_nums2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          val_nums2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">isize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">val_nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vec_resu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buffer </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vec_count </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">isize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> val_nums2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          vec_count </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val_nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">vec_resu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vec_count</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>回到 <code>host/src/main.rs</code>，通过 <code>updated_size</code> 函数读取到在 <code>ta/src/main.rs</code> 中对 <code>vec_resu</code> 新设置的 <code>size</code> 值，也就是 <code>nums1</code> 和 <code>nums2</code> 共有的元素的个数，最后打印出结果向量 <code>resu</code> 的值。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// in data_compute function</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> updated_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> operation</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">parameters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updated_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Intersection resu = {:?}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">resu</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">updated_size</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>这样，我们就基于 Teaclave TrustZone SDK 提供的示例代码实现了自己的求交集和并集函数。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<p>本文首先介绍 Teaclave TrustZone SDK 项目的环境配置过程，然后介绍了简单示例 <code>hello_world-rs</code> 的组织结构和编译过程 ，最后，通过修改 <code>hello_world-rs</code> 实现 <code>intersection</code> 和 <code>union</code> 函数为例，介绍如何基于提供的 SampleCode 进行 Teaclave TrustZone SDK 应用程序的开发。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="延伸阅读">延伸阅读<a href="#延伸阅读" class="hash-link" aria-label="Direct link to 延伸阅读" title="Direct link to 延伸阅读">​</a></h2>
<ul>
<li><a href="https://teaclave.apache.org/trustzone-sdk-docs/" target="_blank" rel="noopener noreferrer">Teaclave TrustZone SDK 文档</a></li>
<li><a href="https://dl.acm.org/doi/10.1145/3427228.3427262" target="_blank" rel="noopener noreferrer">Teaclave TrustZone SDK 项目论文：《RusTEE: Developing Memory-Safe ARM TrustZone Applications》</a></li>
</ul></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/10/14/teaclave-meetup-8">Teaclave Meetup #8</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-10-14T00:00:00.000Z">October 14, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Mingshen Sun</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="agenda">Agenda<a href="#agenda" class="hash-link" aria-label="Direct link to Agenda" title="Direct link to Agenda">​</a></h2>
<ul>
<li>Recent update in Teaclave — Mingshen Sun</li>
<li>Using and Customizing Teaclave SGX SDK — Shunfan Zhou</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="recent-update-in-teaclave--mingshen">Recent Update in Teaclave — Mingshen<a href="#recent-update-in-teaclave--mingshen" class="hash-link" aria-label="Direct link to Recent Update in Teaclave — Mingshen" title="Direct link to Recent Update in Teaclave — Mingshen">​</a></h3>
<p><strong>Platform</strong></p>
<ul>
<li>[docker] start Teaclave docker services with auto-detection mechanism (#559).</li>
<li>Use <code>run-teaclave-service.sh</code> instead of using <code>docker-compose</code> directly.</li>
</ul>
<p><strong>SGX SDK</strong></p>
<ul>
<li>v1.1.4-testing: <a href="https://github.com/apache/incubator-teaclave-sgx-sdk/commits/v1.1.4-testing" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-teaclave-sgx-sdk/commits/v1.1.4-testing</a>
<ul>
<li>Rust <code>nightly-2021-09-13</code></li>
<li>Support Intel SGX SDK 2.15 and DCAP 1.12</li>
</ul>
</li>
<li>Project template refactoring</li>
<li>README polishing</li>
</ul>
<p><strong>TrustZone SDK</strong></p>
<ul>
<li>Teaclave/OP-TEE: Integrating examples in Rust TrustZone SDK in OP-TEE
<ul>
<li>Multiple PRs to OP-TEE&#x27;s <code>manifest</code>, <code>build</code> repos.</li>
<li>Now in the <code>master</code> branch, should be available in the next release 3.15 in Oct 15.</li>
<li>OP-TEE with Rust: <a href="https://optee.readthedocs.io/en/latest/building/optee_with_rust.html" target="_blank" rel="noopener noreferrer">https://optee.readthedocs.io/en/latest/building/optee_with_rust.html</a></li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="OP-TEE with Rust" src="/assets/images/optee-with-rust-doc-a8f3b6b7bbcddffa2a1803fc65387b18.png" width="2234" height="1160" class="img_ev3q"></p>
<p><strong>Website</strong></p>
<ul>
<li>Add project/organization logos in the &quot;Powered By&quot; page: <a href="https://teaclave.apache.org/powered-by/" target="_blank" rel="noopener noreferrer">https://teaclave.apache.org/powered-by/</a></li>
</ul>
<p><img decoding="async" loading="lazy" alt="Project Powered By Teaclave" src="/assets/images/project-powered-by-teaclave-logo-d39c68917c55b2424528f648aa334722.png" width="2738" height="854" class="img_ev3q"></p>
<ul>
<li>Redesign the &quot;Contributors&quot; page
<ul>
<li>add Apache ID, GitHub ID to mentors, PPMC, and committers</li>
<li>Tags for committers to show areas that they are familiar with</li>
</ul>
</li>
<li>Add API Docs (references) of TrustZone SDK both for host and TA sides
<ul>
<li>Host: <a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee-teec" target="_blank" rel="noopener noreferrer">https://teaclave.apache.org/api-docs/trustzone-sdk/optee-teec</a></li>
<li>TA: <a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee-utee" target="_blank" rel="noopener noreferrer">https://teaclave.apache.org/api-docs/trustzone-sdk/optee-utee</a></li>
</ul>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Teaclave TrustZone SDK Links in Homepage" src="/assets/images/teaclave-trustzone-sdk-links-in-homepage-79a052c9781f6bb626d6c8b8dfe13cf2.png" width="2538" height="752" class="img_ev3q"></p>
<ul>
<li>Blog
<ul>
<li><a href="https://teaclave.apache.org/blog/2021-10-06-podling-teaclave-report-october-2021/" target="_blank" rel="noopener noreferrer">Podling Teaclave Report - October 2021</a> · Oct 05 2021</li>
<li><a href="https://teaclave.apache.org/blog/2021-10-01-announcing-teaclave-0-3-0/" target="_blank" rel="noopener noreferrer">Announcing Apache Teaclave™ (incubating) 0.3.0</a> · Sep 30 2021</li>
</ul>
</li>
</ul>
<p><strong>Community</strong></p>
<ul>
<li>New committers: Yuan Zhuang and Rong Fan from Baidu</li>
<li>Discord: Connect directly with Teaclave community members (join link: <a href="https://discord.gg/ynECXsxm5P" target="_blank" rel="noopener noreferrer">https://discord.gg/ynECXsxm5P</a>)</li>
</ul>
<p><strong>Security</strong></p>
<ul>
<li><em>SmashEx: Smashing SGX Enclaves Using Exceptions</em> (to appear at CCS 2021):
Jinhua Cui (National University of Defense Technology, National University of
Singapore); Zhijingcheng Yu (National University of Singapore); Shweta Shinde
(ETH Zurich); Prateek Saxena (National University of Singapore); Zhiping Cai
(National University of Defense Technology)</li>
<li><a href="https://arxiv.org/ftp/arxiv/papers/2110/2110.06657.pdf" target="_blank" rel="noopener noreferrer">https://arxiv.org/ftp/arxiv/papers/2110/2110.06657.pdf</a></li>
<li>CVE-2021-0186
<ul>
<li><a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00548.html" target="_blank" rel="noopener noreferrer">https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00548.html</a></li>
<li><strong>Description</strong>: Improper input validation in the Intel(R) SGX SDK
applications compiled for SGX2 enabled processors may allow a privileged
user to potentially escalation of privilege via local access.</li>
<li><strong>Affected Products</strong>: Intel SGX SDK for Windows v2.12 and earlier, Intel
SGX SDK for Linux v2.13 and earlier, Intel® Processors supporting SGX2.</li>
<li>Intel recommends updating the Intel® SGX SDK to the versions listed below.
Enclaves built with the new Intel® SGX SDK version should increment the
value of their ISVSVN field.</li>
</ul>
</li>
<li>Patch: <a href="https://github.com/intel/linux-sgx/commit/edfe42a517b3e4b1d81204c3cdef6da6cb35fefc" target="_blank" rel="noopener noreferrer">https://github.com/intel/linux-sgx/commit/edfe42a517b3e4b1d81204c3cdef6da6cb35fefc</a></li>
</ul>
<p><img decoding="async" loading="lazy" alt="Patch in Intel SGX SDK" src="/assets/images/cve-2021-0186-patch-faa6b7d42812c2cb5f40541f41158001.png" width="2388" height="1520" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-and-customizing-teaclave-sgx-sdk--shunfan-zhou">Using and Customizing Teaclave SGX SDK — Shunfan Zhou<a href="#using-and-customizing-teaclave-sgx-sdk--shunfan-zhou" class="hash-link" aria-label="Direct link to Using and Customizing Teaclave SGX SDK — Shunfan Zhou" title="Direct link to Using and Customizing Teaclave SGX SDK — Shunfan Zhou">​</a></h3>
<ul>
<li>Teaclave SGX SDK
<ul>
<li>pro: security</li>
<li>con: testing is hard</li>
</ul>
</li>
<li>Case study: rust-bitcoin
<ul>
<li>std</li>
<li>Feature</li>
<li>Port dependencies recursively</li>
</ul>
</li>
<li>Some issues
<ul>
<li>efforts of porting</li>
<li>security: 1) updates of upstream, 2) unit tests</li>
<li>More TEE backend: AMD SEV, ARM CCA</li>
</ul>
</li>
<li>libs is not completed in SGX for vanilla Rust standard library</li>
<li>Phala libc-hacks
<ul>
<li>directly use Intel&#x27;s libc</li>
<li>use ocall warpper functions</li>
</ul>
</li>
<li>Conflicts: multiple language items in Rust</li>
<li>Runtime behavior checks</li>
<li>HW mode issue: <code>rand::thread_rnd()</code> is using CPUID, which is not allowed in SGX</li>
<li>Check instructions after compiling</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="free-discussion">Free Discussion<a href="#free-discussion" class="hash-link" aria-label="Direct link to Free Discussion" title="Direct link to Free Discussion">​</a></h3>
<ul>
<li>About AMD SEV in Azure: <a href="https://azure.microsoft.com/en-us/blog/azure-and-amd-enable-lift-and-shift-confidential-computing/" target="_blank" rel="noopener noreferrer">https://azure.microsoft.com/en-us/blog/azure-and-amd-enable-lift-and-shift-confidential-computing/</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="attendees">Attendees<a href="#attendees" class="hash-link" aria-label="Direct link to Attendees" title="Direct link to Attendees">​</a></h2>
<ul>
<li>Mingshen Sun</li>
<li>Qinkun Bao</li>
<li>He Sun</li>
<li>George</li>
<li>Hongbo Chen</li>
<li>hang</li>
<li>Kevin</li>
<li>Ben</li>
<li>Ruide</li>
<li>Rudong Zhou</li>
<li>shelven</li>
<li>Tongxin Li</li>
<li>Weijie Liu</li>
<li>Zha0Chan</li>
<li>Tianyi Li</li>
<li>DuanRan</li>
<li>Gordon</li>
<li>david</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="group-photo">Group Photo<a href="#group-photo" class="hash-link" aria-label="Direct link to Group Photo" title="Direct link to Group Photo">​</a></h2>
<p><img decoding="async" loading="lazy" alt="Group Photo" src="/assets/images/teaclave-meetup-8-zoom-2474b7cbe44239ceb31b2100c02ea448.png" width="3808" height="2414" class="img_ev3q"></p></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/10/01/announcing-teaclave-0.3.0">Announcing Apache Teaclave™ (incubating) 0.3.0</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-10-01T00:00:00.000Z">October 1, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Mingshen Sun</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>On behalf of the Teaclave community, I am happy to announce the <em>third</em> Apache
Incubator release of Teaclave, 0.3.0. Teaclave is a universal secure computing
platform, making computation on privacy-sensitive data safe and simple.
Apache Teaclave™ (including the
<a href="https://github.com/apache/incubator-teaclave" target="_blank" rel="noopener noreferrer">FaaS platform</a>,
<a href="https://github.com/apache/incubator-teaclave-sgx-sdk" target="_blank" rel="noopener noreferrer">SGX SDK</a>,
and <a href="https://github.com/apache/incubator-teaclave-trustzone-sdk" target="_blank" rel="noopener noreferrer">TrustZone SDK</a>) is
being used and contributed by developers from many organizations and
other open source projects. Please see the <a href="/powered-by"><em>powered by</em></a> page to learn more.</p>
<p>This is the third official Apache Incubator release. In this release, we focus
more on bringing <a href="https://webassembly.org/" target="_blank" rel="noopener noreferrer">WebAssembly</a> into Teaclave. Now, you
can run functions written in different languages in Teaclave with the
WebAssembly executor. Specifically, we modify
<a href="https://github.com/bytecodealliance/wasm-micro-runtime" target="_blank" rel="noopener noreferrer">WebAssembly Micro Runtime</a> and add
it as a new executor in Teaclave.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="highlights">Highlights<a href="#highlights" class="hash-link" aria-label="Direct link to Highlights" title="Direct link to Highlights">​</a></h2>
<p>In this release, we added a new WebAssembly executor which supports to run
function in the WebAssembly bytecode. Therefore, in addition to native code and
Python scripts, Teaclave can run many other languages which can be compiled in
to WebAssembly. This enables a lot of functions of privacy-preseving computation
that are not easily rewritten in Rust or Python. Furthermore, because of the
ecosystem of WebAssembly, we can even run deep neural network models in the
WebAssembly executor.</p>
<p><img decoding="async" loading="lazy" alt="Teaclave Function Executors" src="/assets/images/teaclave-function-executors-wasm-dd2467ef360dd45f571f4a7954920d3e.png" width="2946" height="1046" class="img_ev3q"></p>
<p>To illustrate the capability of the executor, we also support WebAssembly
machine learning models compiled by <a href="https://tvm.apache.org/" target="_blank" rel="noopener noreferrer">Apache TVM</a>.
Apache TVM is an open source machine learning compiler framework for CPUs, GPUs,
and machine learning accelerators. TVM also supports WebAssembly runtime
backend. We also introduce a new MNIST inference example to show the usage of
the new executor with TVM.</p>
<p><img decoding="async" loading="lazy" alt="Using the WebAssembly executor for Machine Learning Inference with TVM" src="/assets/images/teaclave-tvm-webassembly-3a2f265798d6122b93e5fe775ed8201d.png" width="1522" height="908" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="030-release-notes">0.3.0 Release Notes<a href="#030-release-notes" class="hash-link" aria-label="Direct link to 0.3.0 Release Notes" title="Direct link to 0.3.0 Release Notes">​</a></h2>
<p>Here is a list of notable changes in Teaclave version 0.3.0.</p>
<p><strong>Features</strong></p>
<ul>
<li>Add the WebAssembly executor to support functions written in other languages.</li>
<li>Examples of running C and Rust with the WebAssembly executor.</li>
<li>Support inference tasks with models compiled by TVM.</li>
<li>Add the MNIST inference example to demonstrate the ability of using TVM in Teaclave.</li>
</ul>
<p><strong>Enhancements</strong></p>
<ul>
<li>Add the script to simplify developing with editors with Rust&#x27;s Language Server Protocol support.</li>
<li>Upgrade SGX SDK dependencies, i.e., Intel SGX SDK to version 2.14.100.2, DCAP to version 1.11.100.2.</li>
</ul>
<p><strong>Bug Fixes</strong></p>
<ul>
<li>Update the SGX SDK used in the runtime dockerfile.</li>
<li>Fix <code>Python.h</code> not found when compiling <code>acs_py_enclave.c</code>.</li>
<li>Fix building system messed up by untracked <code>Cargo.lock</code> files.</li>
<li>Fix dcap building issue.</li>
</ul>
<p><strong>Docs</strong></p>
<ul>
<li>Add instructions to configure URLs of input/output files in examples.</li>
<li>Executing WebAssembly in Teaclave: <a href="https://teaclave.apache.org/docs/executing-wasm/" target="_blank" rel="noopener noreferrer">https://teaclave.apache.org/docs/executing-wasm/</a>.</li>
<li>Inferencing with TVM in Teaclave: <a href="https://teaclave.apache.org/docs/inference-with-tvm/" target="_blank" rel="noopener noreferrer">https://teaclave.apache.org/docs/inference-with-tvm/</a>.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="download">Download<a href="#download" class="hash-link" aria-label="Direct link to Download" title="Direct link to Download">​</a></h2>
<p>Teaclave 0.3.0 can be downloaded at <a href="/download/">the download page</a>. Note that
it is essential to verify the integrity of the downloaded file using the
PGP signature (the <code>.asc</code> file) or a hash (the <code>.sha256</code> file).</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="documentation">Documentation<a href="#documentation" class="hash-link" aria-label="Direct link to Documentation" title="Direct link to Documentation">​</a></h2>
<p>If it is the first time to try Teaclave, we provide a simple but clear tutorial
to guide you getting stated with Teaclave by invoking
<a href="/docs/my-first-function/">your first function</a> in Teaclave.</p>
<p>Basically, you can build the Teaclave platform using docker with these commands:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ tar zxvf apache-teaclave-0.3.0-incubating.tar.gz &amp;&amp; cd \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  apache-teaclave-0.3.0-incubating</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ # Instructions to verify the source tar: https://teaclave.apache.org/download/#verify-the-integrity-of-the-files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run --rm -v $(pwd):/teaclave -w /teaclave \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -it teaclave/teaclave-build-ubuntu-1804-sgx-2.14:latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   bash -c &quot;. /root/.cargo/env &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     . /opt/sgxsdk/environment &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     mkdir -p build &amp;&amp; cd build &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     cmake -DTEST_MODE=ON -DSGX_SIM_MODE=ON -DGIT_SUBMODULE=OFF .. &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     make&quot;</span><br></span></code></pre></div></div>
<p>Launch all services with <code>docker-compose</code> using simulation mode:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ (cd docker &amp;&amp; docker-compose -f docker-compose-ubuntu-1804-sgx-sim-mode.yml up --build)</span><br></span></code></pre></div></div>
<p>And invoke function with a Python client:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cd examples/python</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ PYTHONPATH=../../sdk/python python3 builtin_echo.py &#x27;Hello, Teaclave!&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] registering user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] login</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] registering function</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] creating task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] approving task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] invoking task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] getting result</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] function return:  b&#x27;Hello, Teaclave!&#x27;</span><br></span></code></pre></div></div>
<p>If you want to understand the internals of Teaclave, we provide several
documents about the <a href="/docs/#design">design</a> of Teaclave. Also, we extensively
document our <a href="/docs/#codebase">codebase</a> in each sub directories. At last, <a href="/docs/#api-references">API references</a>
are automatically generated and uploaded to our homepage.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="community">Community<a href="#community" class="hash-link" aria-label="Direct link to Community" title="Direct link to Community">​</a></h2>
<ul>
<li>Join us on our <a href="https://lists.apache.org/list.html?dev@teaclave.apache.org" target="_blank" rel="noopener noreferrer">mailing list</a> and <a href="https://discord.gg/ynECXsxm5P" target="_blank" rel="noopener noreferrer">Discord channel</a>.</li>
<li>Follow us at <a href="https://twitter.com/ApacheTeaclave" target="_blank" rel="noopener noreferrer">@ApacheTeaclave</a>.</li>
<li>Meet us at our <a href="https://teaclave.apache.org/community/#calendar" target="_blank" rel="noopener noreferrer">monthly community meetup</a>.</li>
<li>See <a href="https://teaclave.apache.org/community/" target="_blank" rel="noopener noreferrer">more</a>.</li>
</ul></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/08/26/teaclave-meetup-7">Teaclave Meetup #7</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-08-26T00:00:00.000Z">August 26, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Mingshen Sun</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>In Aug 26, we gathered on Zoom for the 7th Teaclave meetup. In this meetup,
Mingshen briefly introduce recent updates in Teaclave, and also introduce new
members attending the meetup.</p>
<p>For all Teaclave events, we publish a <em>Teaclave Community Event Calendar</em>:
<a href="https://calendar.google.com/calendar/u/0/embed?src=l1q5osem2br8i4bj7dgik5sae4@group.calendar.google.com" target="_blank" rel="noopener noreferrer">https://calendar.google.com/calendar/u/0/embed?src=l1q5osem2br8i4bj7dgik5sae4@group.calendar.google.com</a>.
You can subscribe to see our latest schedule information including the Zoom
link.</p>
<p>Here is the minutes for Teaclave Meetup #7 on Aug 26, 2021.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="attendees">Attendees<a href="#attendees" class="hash-link" aria-label="Direct link to Attendees" title="Direct link to Attendees">​</a></h2>
<ul>
<li>Mingshen Sun</li>
<li>Ran Duan</li>
<li>Tianyi Li</li>
<li>Ruide Zhang</li>
<li>Yanhua Luo</li>
<li>Hongbo Chen</li>
<li>Weijie Liu</li>
<li>Tongxin Li</li>
<li>Wenhao Wang</li>
<li>Chan Zhao</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="agenda">Agenda<a href="#agenda" class="hash-link" aria-label="Direct link to Agenda" title="Direct link to Agenda">​</a></h2>
<ul>
<li>Recent updates in Teaclave - Mingshen Sun</li>
<li>Free discussion</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="recent-updates-in-teaclave---mingshen">Recent updates in Teaclave - Mingshen<a href="#recent-updates-in-teaclave---mingshen" class="hash-link" aria-label="Direct link to Recent updates in Teaclave - Mingshen" title="Direct link to Recent updates in Teaclave - Mingshen">​</a></h3>
<p><strong>Teaclave Faas Platform</strong></p>
<ul>
<li>Add TVM MNIST example (#535)</li>
<li>Add IDE helper script (#539)</li>
<li>Release v0.3.0: <a href="https://teaclave.apache.org/download/#teaclave" target="_blank" rel="noopener noreferrer">https://teaclave.apache.org/download/#teaclave</a></li>
</ul>
<p><strong>Teaclave TrustZone SDK</strong></p>
<ul>
<li>TEE Socket APIs and examples</li>
<li>Upgrade building docker to Ubuntu 20.04</li>
<li>Switch to GitHub Actions</li>
<li>Add -rs to examples and update test scripts (#34)</li>
<li>Update to OP-TEE 3.14.0 (#35)</li>
</ul>
<p><strong>Teaclave SGX SDK</strong></p>
<ul>
<li>Intel SGX SDK 2.14</li>
</ul>
<p><strong>Website</strong></p>
<ul>
<li>[blog] <a href="https://teaclave.apache.org/blog/2021-08-02-podling-teaclave-report-august-2021/" target="_blank" rel="noopener noreferrer">Podling Teaclave Report - August 2021 · Aug 01 2021</a></li>
<li>[blog] <a href="https://teaclave.apache.org/blog/2021-08-25-developing-sgx-application-with-teaclave-sgx-sdk/" target="_blank" rel="noopener noreferrer">使用 Teaclave SGX SDK 开发 SGX 应用 · Aug 24 2021</a></li>
</ul>
<p><strong>External Collaboration</strong></p>
<ul>
<li>Teaclave/Intel: Integrating Graphene as a new Library OS executor</li>
<li>Teaclave/OP-TEE: Integrating examples in Rust TrustZone SDK in OP-TEE</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="free-discussion">Free Discussion<a href="#free-discussion" class="hash-link" aria-label="Direct link to Free Discussion" title="Direct link to Free Discussion">​</a></h3>
<p>Intro</p>
<ul>
<li>New members: Tianyi Li from Ant Group, Wenhao Wang from CAS</li>
</ul>
<p>About Occlum NGO</p>
<ul>
<li>Mingshen: what is Occlum NGO? <a href="https://github.com/occlum/ngo" target="_blank" rel="noopener noreferrer">https://github.com/occlum/ngo</a></li>
<li>Wenhao: related news: <a href="https://juejin.cn/post/6963839027665436709" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6963839027665436709</a></li>
<li>Ran: will discuss with the Occlum group</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="group-photos">Group Photos<a href="#group-photos" class="hash-link" aria-label="Direct link to Group Photos" title="Direct link to Group Photos">​</a></h2>
<p><img decoding="async" loading="lazy" alt="Teaclave Meetup #7" src="/assets/images/teaclave-meetup-7-zoom-fb72705d1f17840d53367f1ef09d0da1.png" width="3808" height="2414" class="img_ev3q"></p></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/08/25/developing-sgx-application-with-teaclave-sgx-sdk">使用 Teaclave SGX SDK 开发 SGX 应用</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-08-25T00:00:00.000Z">August 25, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Wenwen Ruan</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>[[TOC]]</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="teaclave-sgx-sdk应用开发环境简介以及搭建">Teaclave SGX SDK应用开发环境简介以及搭建<a href="#teaclave-sgx-sdk应用开发环境简介以及搭建" class="hash-link" aria-label="Direct link to Teaclave SGX SDK应用开发环境简介以及搭建" title="Direct link to Teaclave SGX SDK应用开发环境简介以及搭建">​</a></h2>
<p>Intel SGX (Software Guard Extension, 软件防护扩展) 因为其较为出色的性能和安全性，是目前最为学术界和工业界关注的 TEE (Trusted Execution Environment, 可信执行环境)。Intel SGX 在内存中划分了名为 enclave（飞地）的隔离区域，用来存放敏感数据和代码。通过提供该隔离的可信执行环境，enclave 在操作系统、BIOS 和虚拟机监控器等系统软件均不可信的情况下，仍然对 enclave 内部的代码和数据提供保护，保障用户的关键数据和代码的机密性和完整性。</p>
<p>但如果 Intel SGX 程序仍然使用 C/C++ 这类内存不安全的语言开发的话，就会和传统软件一样面临着内存破坏漏洞的问题。对于 enclave 来说，受到的危害会更为严重，因为 enclave 中保存的多是机密数据和代码。Teaclave SGX 的主要目标就是通过使用高效的内存安全语言 —— Rust 来支持 enclave 应用程序的开发，从而在保证 Intel SGX enclave 内存安全的同时不会带来显著的性能开销。</p>
<p>Teaclave SGX SDK 内部结构分为三层：</p>
<ul>
<li>最底层是使用 C/C++ 和汇编实现的 Intel SGX SDK。</li>
<li>中间层是 Rust 对 C/C++ 的 FFI (Foreign function Interfaces, 外部函数接口)。</li>
<li>最高层是 Teaclave SGX SDK。</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Teaclave SGX SDK 概要图" src="/assets/images/2021-08-13-overview-of-teaclave-sgx-sdk-cn-b86d37357d198f14e10fbbcb03fe612c.png" width="1050" height="964" class="img_ev3q"></p>
<p>Teaclave SGX SDK 应用程序开发者在进行开发时就只需要基于最上层的 Teaclave SGX SDK 来进行开发，底层的实现对于开发者来说是透明的。本文将从开发者的角度介绍基于 Teaclave SGX SDK 开发自己的应用程序的过程。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="准备条件">准备条件<a href="#准备条件" class="hash-link" aria-label="Direct link to 准备条件" title="Direct link to 准备条件">​</a></h3>
<ul>
<li>Ubuntu16.04 或者 18.04 或者 20.04 (Teaclave SGX SDK v1.1.3 中增加了对 Ubuntu 20.04 的支持)</li>
<li>docker 环境</li>
</ul>
<p><em>本文基于 Teaclave SGX SDK v1.1.3 提交哈希值：d107bd0718f723221750a4f2973451b386cbf9d2</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基于-docker-配置-teaclave-sgx-sdk-开发环境">基于 docker 配置 Teaclave SGX SDK 开发环境<a href="#基于-docker-配置-teaclave-sgx-sdk-开发环境" class="hash-link" aria-label="Direct link to 基于 docker 配置 Teaclave SGX SDK 开发环境" title="Direct link to 基于 docker 配置 Teaclave SGX SDK 开发环境">​</a></h3>
<p>首先需要用户机器 CPU 支持 Intel SGX 并且在 BIOS 上开启了 Intel SGX 支持。用户可以通过 <a href="https://github.com/ayeks/SGX-hardware" target="_blank" rel="noopener noreferrer">SGX-hardware项目</a> 或者在 <a href="https://www.intel.com/content/www/us/en/products/details/processors.html" target="_blank" rel="noopener noreferrer">Intel 官网</a> 中搜索自己的 CPU 型号查看是否支持 Intel SGX。下图以 Intel Core i7-7700K 处理器为例，如下图所示，该机型支持 SGX。</p>
<p><img decoding="async" loading="lazy" alt="sgx-enable.png" src="/assets/images/2021-08-13-sgx-enable-d429fcecc11ac9b4cfa4290dfbc507aa.png" width="1232" height="710" class="img_ev3q"></p>
<p>当确定 CPU 支持 Intel SGX 之后，还需要开启 BIOS 中的 SGX 选项。CPU 上的 SGX 选项可能有 <code>enabled</code> 或者 <code>software controlled</code>。具有 <code>enabled</code> 选项的主机直接在 BIOS 上选择 <code>enabled</code> 即可，而<code>software controlled</code> 表示 SGX 的开启需要由软件触发，还需通过 Intel 官方提供的 <a href="https://github.com/intel/sgx-software-enable" target="_blank" rel="noopener noreferrer">sgx-software-enable</a> 开启。下载好 <code>sgx-software-enable</code> 之后，运行 <code>Makefile</code> 编译生成可执行代码 <code>sgx_enable</code> ，执行 <code>sudo ./sgx_enable</code> 顺利运行后重启主机，即可顺利开启 Intel SGX。</p>
<p>硬件条件准备完毕之后，还需要安装 <a href="https://download.01.org/intel-sgx/sgx-linux/2.10/distro/ubuntu16.04-server/sgx_linux_x64_driver_2.6.0_602374c.bin" target="_blank" rel="noopener noreferrer">Linux SGX 驱动</a>（本实验环境的操作系统版本为 ubuntu16.04 ，安装时需要根据自己的操作系统版本号在 <a href="https://download.01.org/intel-sgx/" target="_blank" rel="noopener noreferrer">官网</a> 下载对应的 Intel SGX 驱动） ，安装完毕之后需要确认 <code>/dev/isgx</code> 的存在。</p>
<p>下载 Teaclave SGX SDK 以及支持编译 SGX 设备的 docker image。</p>
<p><code>$ https://github.com/apache/incubator-teaclave-sgx-sdk</code></p>
<p><code>$ docker pull baiduxlab/sgx-rust</code></p>
<p>启动一个 docker，并且把 Teaclave SGX SDK 项目目录映射到 docker 中。</p>
<p><code>$ docker run -v /your/absolute/path/to/incubator-teaclave-sgx-sdk:/root/sgx -ti --device /dev/isgx baiduxlab/sgx-rust</code></p>
<p>在运行的 docker container 中启动 aesm 服务，<strong>White list update request successful for Version</strong> 语句意味着启动成功。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@docker:/# LD_LIBRARY_PATH=/opt/intel/sgx-aesm-service/aesm/ /opt/intel/sgx-aesm-service/aesm/aesm_service &amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aesm_service[17]: [ADMIN]White List update requested</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aesm_service[17]: Failed to load QE3: 0x4004</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aesm_service[17]: The server sock is 0x56096ab991c0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aesm_service[17]: [ADMIN]White list update request successful for Version: 103</span><br></span></code></pre></div></div>
<p>执行 Teaclave SGX SDK 中的简单实例 helloworld ，检查是否正常运行。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">root@docker:~# cd sgx/samplecode/helloworld/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@docker:~/sgx/samplecode/helloworld# make</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@docker:~/sgx/samplecode/helloworld# cd bin/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root@docker:~/sgx/samplecode/helloworld/bin# ./app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] global_eid: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is normal world string passed into enclave!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">This is a Rust string!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] say_something success ...</span><br></span></code></pre></div></div>
<p>至此，我们已经成功在自己的机器上跑起来了 Teaclave SGX SDK 的 helloworld 示例啦！</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="teaclave-sgx-sdk-示例-helloworld-剖析">Teaclave SGX SDK 示例 helloworld 剖析<a href="#teaclave-sgx-sdk-示例-helloworld-剖析" class="hash-link" aria-label="Direct link to Teaclave SGX SDK 示例 helloworld 剖析" title="Direct link to Teaclave SGX SDK 示例 helloworld 剖析">​</a></h2>
<p>接下来，我们通过阅读 helloworld 这个简单的例子来理解 Teaclave SGX SDK 应用程序的组织结构和运行方式。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="helloworld-目录结构">helloworld 目录结构<a href="#helloworld-目录结构" class="hash-link" aria-label="Direct link to helloworld 目录结构" title="Direct link to helloworld 目录结构">​</a></h3>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helloworld/ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── app </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── app.c </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── app.h </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── bin </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── readme.txt </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── enclave </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave.config.xml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave.edl </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave.lds </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave_private.pem </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Makefile </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── src </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── lib.rs </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── x86_64-unknown-linux-sgx.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── Xargo.toml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── lib </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── readme.txt </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── Makefile </span><br></span></code></pre></div></div>
<p>helloworld 的目录结构和 Intel SGX 的 <a href="https://github.com/intel/linux-sgx/blob/HEAD/SampleCode/SampleEnclave" target="_blank" rel="noopener noreferrer">SampleEnclave</a> 目录结构非常类似。</p>
<ul>
<li>app 目录中存放的是不可信部分代码，包括 <code>main</code> 函数以及 <code>OCALL</code> 函数具体逻辑实现。</li>
<li>enclave 目录中存放的是可信部分代码，主要是 <code>ECALL</code> 函数具体逻辑实现。
<ul>
<li>不同于 SGX ，应用安全区的代码实现位于 <strong><code>src/lib.rs</code></strong>, 该文件是整个 <code>helloworld</code> 文件夹中唯一使用 Rust 编写的文件，程序员可以在该文件中增加需要的功能。</li>
<li>另外，enclave 文件夹下多了 <code>Cargo.toml</code>, <code>src/lib.rs</code>, <code>x86_64-unknown-linux-sgx.json</code>, <code>Xargo.toml</code>：
<ul>
<li><strong><code>Cargo.toml</code></strong>: 项目清单文件，包括项目名称、项目版本以及依赖项等。</li>
<li><strong><code>x86_64-unknown-linux-sgx.json</code></strong> 和 <strong><code>Xargo.toml</code></strong> 描述了用于项目交叉编译的信息。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="重要代码文件解析">重要代码文件解析<a href="#重要代码文件解析" class="hash-link" aria-label="Direct link to 重要代码文件解析" title="Direct link to 重要代码文件解析">​</a></h3>
<ul>
<li><strong><code>Enclave.edl</code></strong> <br>
该文件规定了 Enclave 边界 <code>ECALL/OCALL</code> 的定义。</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enclave {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from &quot;sgx_tstd.edl&quot; import *;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from &quot;sgx_stdio.edl&quot; import *;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from &quot;sgx_backtrace.edl&quot; import *;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from &quot;sgx_tstdc.edl&quot; import *;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    trusted {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        /* define ECALLs here. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public sgx_status_t say_something([in, size=len] const uint8_t* some_string, size_t len);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    untrusted {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre></div></div>
<p><code>trusted {...}</code> 中声明 <code>ECALL</code> 函数， <code>untrusted {...}</code> 中声明 <code>OCALL</code> 函数。本例中声明了一个 <code>ECALL</code> 函数 <code>say_something</code>，该函数的具体实现在 <code>src/lib.rs</code> 中，它的参数包括 <code>uint8_t *</code> 类型的指针和长度参数 <code>len</code>。</p>
<ul>
<li><strong><code>app/app.c</code></strong></li>
</ul>
<p>在 <code>app/app.c</code> 的 <code>main</code> 函数中有一个完整的调用 <code>ECALL</code> 的例子。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sgx_ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">say_something</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">global_eid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">enclave_ret</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token class-name">uint8_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>这里的 <code>say_something</code> 似乎和 <code>Enclave.edl</code> 中的声明不太一样，ECALL传递参数时多了两个隐参数：<code>enclave_eid</code> 和 <code>say_something</code> 的返回值 <code>&amp;enclave_ret</code>。而 <code>sgx_ret</code> 表示的是 ECALL 执行是否成功，是 SGX 的返回值。</p>
<ul>
<li><strong><code>enclave/</code>文件夹部分</strong></li>
</ul>
<p><code>enclave/Cargo.toml</code> 中声明了这是一个 <code>staticlib</code>，表明 Enclave 在最后会被编译成一个 <code>.a</code> 文件，该文件会和 Intel 提供的 <code>sgx_tstdc.a</code> 等文件链接形成 <code>enclave.so</code>，再经由 <code>sgx_sign</code> 工具配合 <code>Enclave.config.xml</code> 配置文件、<code>Enclave_private.pem</code> 签名私钥做签名并计算 <code>measurement</code> ，最后生成 <code>enclave.signed.so</code>，这是 Enclave 的完全体。</p>
<ul>
<li><strong><code>enclave/src/lib.rs</code></strong></li>
</ul>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">say_something</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">some_string</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> some_len</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> sgx_status_t </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> str_slice </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">slice</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">from_raw_parts</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">some_string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> some_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">io</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">stdout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">str_slice</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// A sample &amp;&#x27;static string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> rust_raw_string </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;This is a &quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// An array</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> word</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">u8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">82</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">117</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">115</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">116</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// An vector</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> word_vec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">vec!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">115</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">116</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">114</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">105</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">110</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">103</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">33</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Construct a string from &amp;&#x27;static string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> hello_string </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rust_raw_string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Iterate on word array</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> c </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> word</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hello_string</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">c </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Rust style convertion</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hello_string </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_utf8</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">word_vec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Invalid UTF-8&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                               </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">as_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Ocall to normal world for output</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;{}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hello_string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token namespace" style="opacity:0.7">sgx_status_t</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token constant" style="color:#36acaa">SGX_SUCCESS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>该函数实现了一个简单的将 <code>&amp;[u8]</code> 数组转化为字符串输出的函数，注意在函数的最后调用的 <code>println!</code> 函数是一个 <code>OCALL</code>。 <code>println!</code> 的具体实现中加入了内置的 <code>OCALL</code>，并定义了内置的 <code>edl</code> ，import到了 <code>Enclave.edl</code> 中。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">enclave {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from &quot;sgx_tstd.edl&quot; import *;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from &quot;sgx_stdio.edl&quot; import *;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from &quot;sgx_backtrace.edl&quot; import *;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    from &quot;sgx_tstdc.edl&quot; import *;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="编译后的代码目录">编译后的代码目录<a href="#编译后的代码目录" class="hash-link" aria-label="Direct link to 编译后的代码目录" title="Direct link to 编译后的代码目录">​</a></h3>
<p>经过编译之后的代码目录如下所示，这里省略了 <code>release</code> 文件夹下的内容。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">├── app </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── app.c </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── app.h </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── app.o               #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave_u.c         #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave_u.h         #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── Enclave_u.o         #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── bin </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── app                 #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── enclave.signed.so   #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── readme.txt </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── enclave </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.lock          #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave.config.xml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave.edl </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave.lds </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave_private.pem </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── enclave.so          #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave_t.c         #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave_t.h         #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Enclave_t.o         #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Makefile </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── src </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── lib.rs </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── target              #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   ├── CACHEDIR.TAG    #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── release         #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── x86_64-unknown-linux-sgx.json </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── Xargo.toml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── lib </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── libenclave.a        #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── libsgx_ustdc.a      #[generate] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── readme.txt </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── Makefile </span><br></span></code></pre></div></div>
<p>helloworld 编译的基本流程类似于 Intel SGX:</p>
<ul>
<li><code>edger8r</code> 将输入的 <code>EDL</code> 在 <code>app/</code> 目录下生成不可信代码 <code>Enclave_u.h</code> 和 <code>Enclave_u.c</code>；</li>
<li>编译不可信部分生成 <code>bin/app</code>；</li>
<li><code>edger8r</code> 在 <code>enclave/</code> 目录下生成可信代码 <code>Enclave_t.h</code> 和 <code>Enclave_t.c</code>；</li>
<li>编译并签名生成可信动态链接库 <code>enclave.signed.so</code>。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="开发者如何开发自己的-rust-sgx-application">开发者如何开发自己的 Rust SGX Application<a href="#开发者如何开发自己的-rust-sgx-application" class="hash-link" aria-label="Direct link to 开发者如何开发自己的 Rust SGX Application" title="Direct link to 开发者如何开发自己的 Rust SGX Application">​</a></h2>
<p>同样类似于开发 Intel SGX Application，用户可以通过改写 Teaclave SGX SDK 所提供的 <code>samplecode</code>，在这里，我以一个简单的例子抛砖引玉。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="添加自定义的函数">添加自定义的函数<a href="#添加自定义的函数" class="hash-link" aria-label="Direct link to 添加自定义的函数" title="Direct link to 添加自定义的函数">​</a></h3>
<p>假设用户希望在 Teaclave SGX SDK 中实现一个简单的求两个数组的交集的函数，只需要直接在 <code>src/lib.rs</code> 中添加实现的函数。下面的示例代码 <code>intersection</code> 函数是希望添加的求交集函数，注意这里求到的交集结果是无重复元素的。传入的两个参数是需要求交集的 <code>i32</code> 向量，最后返回的是两个向量的交集。其具体的实现是通过一个额外的散列集，记录 <code>num1</code> 出现的元素，再对 <code>num2</code> 进行遍历，如果 <code>num2</code> 出现了散列集中的元素，则将该值 <code>push</code> 到交集数组中，并将散列表中的对应元素移除。当 <code>num2</code> 遍历完毕之后，返回交集数组。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">intersection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">i32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nums2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">i32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">i32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">collections</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">HashSet</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> set</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">HashSet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">i32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HashSet</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> vec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">i32</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> nums1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> nums2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">iter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                vec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> vec</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>考虑一个比较现实的场景，两个用户分别将自己的向量作为参数传入 enclave 中进行计算，这时候数据需要从不可信代码区域复制到可信代码区域。
首先，需要在 <code>Enclave.edl</code> 文件中修改 <code>say_something</code> 函数的定义，输入参数为两个用户的向量指针以及对应的向量大小。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public sgx_status_t say_something([in, size=len1] size_t* num1, size_t len1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  [in, size=len2] size_t* num2, size_t len2);</span><br></span></code></pre></div></div>
<p>接着，在 <code>app.c</code> 文件中声明需要求交集的数组以及大小并仿照示例调用 <code>say_something</code>。</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> nums1</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> nums2</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">11</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">,</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> len1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">size_t</span><span class="token plain"> len2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">sizeof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sgx_ret </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">say_something</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">global_eid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">enclave_ret</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            nums1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            len1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            nums2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                            len2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>回到 <code>enclave/src/lib.rs</code>，<code>say_something</code> 传进来的是两个向量的起始地址以及大小。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">say_something</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nums2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> sgx_status_t </span><br></span></code></pre></div></div>
<p>由于数据是从非安全区复制到安全区的，还需要对 <code>intersection</code> 函数进行部分改写。传进来的参数是数组指针，以指针地址为起始地址，根据大小参数限制迭代范围并获得一个用于循环的序号变量 <code>i</code>，在 <code>for</code> 循环中使用 <code>offset</code> 偏移指针，解引用它，读出 <code>nums1</code> 和 <code>nums2</code> 的元素值。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">intersection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nums2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">collections</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">HashSet</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> set</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">HashSet</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">HashSet</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> vec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">len1</span><span class="token operator" style="color:#393A34">/</span><span class="token namespace" style="opacity:0.7">mem</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">size_of</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> val_nums1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val_nums1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">isize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val_nums1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">len2</span><span class="token operator" style="color:#393A34">/</span><span class="token namespace" style="opacity:0.7">mem</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">size_of</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> val_nums2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">unsafe</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            val_nums2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nums2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">offset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">isize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">val_nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            vec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">val_nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            set</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">val_nums2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> vec</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>完整的 <code>say_something</code> 函数如下所示。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[no_mangle]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">say_something</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nums2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token keyword" style="color:#00009f">mut</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">usize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> sgx_status_t </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> vec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">usize</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">intersection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nums1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nums2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> len2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">println!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;intersection set is {:?}&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token namespace" style="opacity:0.7">sgx_status_t</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token constant" style="color:#36acaa">SGX_SUCCESS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>重新编译并运行，得到运行结果：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[+] global_eid: 2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">intersection set is [5, 6, 7, 8, 9]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+] say_something success ...</span><br></span></code></pre></div></div>
<p>我们基于 Teaclave SGX SDK 的 helloworld 实现了自己的求交集函数。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="调用-teaclave-sgx-sdk-提供的-crate">调用 Teaclave SGX SDK 提供的 <code>crate</code><a href="#调用-teaclave-sgx-sdk-提供的-crate" class="hash-link" aria-label="Direct link to 调用-teaclave-sgx-sdk-提供的-crate" title="Direct link to 调用-teaclave-sgx-sdk-提供的-crate">​</a></h3>
<p>Teaclave SGX SDK 重写了很多 SGX 的库，当我们需要用某个库时，可以先在仓库中查看是否有相应的 <code>crate</code> 实现以及对应的 <a href="https://teaclave.apache.org/api-docs/crates-enclave/" target="_blank" rel="noopener noreferrer">doc</a>。比如当我们希望生成一个随机数时，在 <code>C++</code> 或者 <code>Rust</code> 环境下，会想到使用 <code>rand</code> 库。自然而然地，Teaclave SGX SDK 也用 Rust 重写了 <a href="https://github.com/apache/incubator-teaclave-sgx-sdk/tree/master/sgx_rand" target="_blank" rel="noopener noreferrer"><code>sgx_rand</code></a> 库。</p>
<p>首先在 <code>enclave/Cargo.toml</code> 中的 <code>[target.&#x27;cfg(not(target_env = &quot;sgx&quot;))&#x27;.dependencies]</code> 部分添加 <code>sgx_rand</code> 库的地址。</p>
<div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[target.&#x27;cfg(not(target_env = &quot;sgx&quot;))&#x27;.dependencies]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sgx_rand = {git = &quot;https://github.com/apache/teaclave-sgx-sdk.git&quot; }</span><br></span></code></pre></div></div>
<p>现在万事俱备，只欠调用。回到 <code>lib.rs</code> 文件中，链接到 <code>sgx_rand</code> <code>crate</code>，导入其中的所有项，声明需要使用的模块。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">crate</span><span class="token plain"> </span><span class="token module-declaration namespace" style="opacity:0.7">sgx_rand</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">sgx_rand</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Rng</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">sgx_rand</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">os</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">SgxRng</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>调用 <code>gen_range</code> 函数生成 0-10 之间的随机数。</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> random </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rng</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">gen_range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<p>这样就可以在 Teaclave SGX SDK 中的 enclave 中通过调用官方 <code>crate</code> 随机生成一个随机数。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<p>本文首先介绍了 Teaclave SGX SDK 项目的基本结构，然后以 <code>helloworld</code> 为例子，介绍了一个简单的 Teaclave SGX SDK 的示例的组织结构和编译过程，最后，以在 <code>helloworld</code> 中实现 <code>intersection</code> 函数为例，介绍了如何基于提供的 SampleCode 进行 Teaclave SGX SDK 应用程序的开发。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="延伸阅读">延伸阅读<a href="#延伸阅读" class="hash-link" aria-label="Direct link to 延伸阅读" title="Direct link to 延伸阅读">​</a></h2>
<ul>
<li><a href="https://github.com/dingelish/SGXfail/blob/master/01.md" target="_blank" rel="noopener noreferrer">一份主观的 SGX 导读：运行第一个 SGX 程序</a></li>
<li><a href="http://teaclave.apache.org" target="_blank" rel="noopener noreferrer">Teaclave 官网</a></li>
<li><a href="https://dl.acm.org/citation.cfm?id=3354241" target="_blank" rel="noopener noreferrer">Teaclave SGX SDK 项目论文：《Towards Memory Safe Enclave Programming with Rust-SGX》</a></li>
</ul></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/07/29/teaclave-meetup-6">Teaclave Meetup #6</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-07-29T00:00:00.000Z">July 29, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Mingshen Sun</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>In July 29, we gathered on Zoom for the sixth Teaclave meetup. In the meetup, we
announced our new mentor Gordon and invited Gordon to introduce the latest effort
on integrating Graphene into Teaclave.</p>
<p><img decoding="async" loading="lazy" alt="Teaclave Meetup #6" src="/assets/images/teaclave-meetup-6-zoom-3511a84c023b03d900b2a2299d60742d.png" width="3198" height="2414" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="schedule">Schedule<a href="#schedule" class="hash-link" aria-label="Direct link to Schedule" title="Direct link to Schedule">​</a></h2>
<ul>
<li>Recent update of Teaclave, Mingshen (5m)</li>
<li>Introduction to Graphene, Gordon</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<ul>
<li><a href="https://github.com/apache/incubator-teaclave/issues/525" target="_blank" rel="noopener noreferrer">Proposal on Teaclave/Graphene integration</a></li>
<li><a href="https://grapheneproject.io/wp-content/uploads/2020/01/Intel_SGX_Day_19_Graphene_Talk.pdf" target="_blank" rel="noopener noreferrer">Graphene v1.0: Toward A Reliable, Open-Source Library OS for SGX</a></li>
<li><a href="https://osseu18.sched.com/event/FxXc/library-os-is-the-new-container-why-is-library-os-a-better-option-for-compatibility-and-sandboxing-chia-che-tsai-uc-berkeley" target="_blank" rel="noopener noreferrer">Library OS is the New Container</a></li>
<li><a href="https://static.sched.com/hosted_files/lsseu2020/46/Oct%2029_Architectural%20Extensions%20for%20VM%20Isolation%20to%20Advance%20Confidential%20Computing_Ravi%20Sahita_Jun%20Nakajima_v4b.pdf" target="_blank" rel="noopener noreferrer">Intel® TDX Architectural Extensions to Advance Confidential Computing in Public Clouds</a></li>
</ul></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/06/24/teaclave-meetup-5">Teaclave Meetup #5</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-06-24T00:00:00.000Z">June 24, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Mingshen Sun</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>In Jun 24, we gathered in Zoom for the fifth monthly Teaclave meetup. In this
meetup, we&#x27;re glad to have Hongbo (@ya0guang) talking about his contributions on
adding WebAssembly Micro Runtime to Teaclave as an executor (PR:
<a href="https://github.com/apache/incubator-teaclave/pull/504" target="_blank" rel="noopener noreferrer">#504</a>,
<a href="https://github.com/apache/incubator-teaclave/pull/512" target="_blank" rel="noopener noreferrer">#512</a>).</p>
<p><img decoding="async" loading="lazy" alt="Teaclave Meetup #5" src="/assets/images/teaclave-meetup-5-zoom-392d54c515015619afa363eb22cd94e2.png" width="3584" height="2274" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="schedule">Schedule<a href="#schedule" class="hash-link" aria-label="Direct link to Schedule" title="Direct link to Schedule">​</a></h2>
<ul>
<li>Recent update of Teaclave, Mingshen (5m)</li>
<li>Executing WebAssembly in Teaclve, Hongbo (40m)</li>
<li>Open discussion</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="notes">Notes<a href="#notes" class="hash-link" aria-label="Direct link to Notes" title="Direct link to Notes">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="recent-update-of-teaclave">Recent Update of Teaclave<a href="#recent-update-of-teaclave" class="hash-link" aria-label="Direct link to Recent Update of Teaclave" title="Direct link to Recent Update of Teaclave">​</a></h3>
<p><strong>Teaclave TrustZone SDK version 0.1.0 released</strong></p>
<ul>
<li>Vote result: <a href="https://lists.apache.org/thread.html/r441addf283f6c8780326f372e39a9d723164f6d910184ea3686a5c4a%40%3Cdev.teaclave.apache.org%3E" target="_blank" rel="noopener noreferrer">https://lists.apache.org/thread.html/r441addf283f6c8780326f372e39a9d723164f6d910184ea3686a5c4a%40%3Cdev.teaclave.apache.org%3E</a></li>
<li>Release notes: <a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/releases/tag/v0.1.0" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-teaclave-trustzone-sdk/releases/tag/v0.1.0</a></li>
<li>Download link: <a href="https://teaclave.apache.org/download/" target="_blank" rel="noopener noreferrer">https://teaclave.apache.org/download/</a></li>
</ul>
<p><strong>Linaro OP-TEE Contributions meeting</strong></p>
<ul>
<li>Recording: <a href="https://linaro-org.zoom.us/rec/share/0o3Ku4zaXSrP-Ep0WI5P-XB-KAiP5d94kXbKmg43VqrnRHUmsLV_sv1wI01JbL0C.kSM-_ov2pc9Sggf_" target="_blank" rel="noopener noreferrer">https://linaro-org.zoom.us/rec/share/0o3Ku4zaXSrP-Ep0WI5P-XB-KAiP5d94kXbKmg43VqrnRHUmsLV_sv1wI01JbL0C.kSM-<em>ov2pc9Sggf</em></a>, Passcode: 9c.&amp;%KR6</li>
<li>Slides: <a href="https://drive.google.com/file/d/1YPig8k-xRyeRxuu1ALTmkqY-nxtH5upR/view?usp=sharing" target="_blank" rel="noopener noreferrer">https://drive.google.com/file/d/1YPig8k-xRyeRxuu1ALTmkqY-nxtH5upR/view?usp=sharing</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="executing-webassembly-in-teaclave">Executing WebAssembly in Teaclave<a href="#executing-webassembly-in-teaclave" class="hash-link" aria-label="Direct link to Executing WebAssembly in Teaclave" title="Direct link to Executing WebAssembly in Teaclave">​</a></h3>
<p><img decoding="async" loading="lazy" alt="Executing WebAssembly in Teaclave" src="/assets/images/teaclave-meetup-5-webassembly-d437bbb96517957e2157ed6d691a4a85.png" width="1560" height="710" class="img_ev3q"></p>
<ul>
<li><a href="/assets/files/teaclave-meetup-5-executing-webassembly-in-teaclave-888b07d231f2357fbb59315fe3f84ea1.pdf" target="_blank">Slides</a></li>
</ul>
<p>Some question and discussion:</p>
<ul>
<li>Can we reuse the WebAssembly runtime to improve the performance of startup?</li>
<li>Bridging <code>tlibc</code> functions into WAMR.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="open-discussion">Open Discussion<a href="#open-discussion" class="hash-link" aria-label="Direct link to Open Discussion" title="Direct link to Open Discussion">​</a></h3>
<ul>
<li>ARM CCA: <a href="https://www.arm.com/why-arm/architecture/security-features/arm-confidential-compute-architecture" target="_blank" rel="noopener noreferrer">https://www.arm.com/why-arm/architecture/security-features/arm-confidential-compute-architecture</a></li>
<li>EdgelessSys mablerun: <a href="https://github.com/edgelesssys/marblerun" target="_blank" rel="noopener noreferrer">https://github.com/edgelesssys/marblerun</a></li>
<li>Attestation mechanism in Google Cloud Confidential Computing</li>
</ul></div></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2021/06/16/announcing-teaclave-trustzone-sdk-0.1.0">Announcing Apache Teaclave™ TrustZone SDK (incubating) 0.1.0</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2021-06-16T00:00:00.000Z">June 16, 2021</time></div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><span class="authorName_yefp">Mingshen Sun</span></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div class="markdown"><p>On behalf of the Teaclave community, I am happy to announce the release of
Teaclave TrustZone SDK 0.1.0. This is the first Apache Incubator release since
the recent donation to the Teaclave community.</p>
<p>Teaclave TrustZone SDK provides abilities to build safe TrustZone applications
in Rust. The SDK is based on the OP-TEE project which follows GlobalPlatform TEE
specifications and provides ergonomic APIs. In addition, it enables capability
to write TrustZone applications with Rust&#x27;s standard library and many
third-party libraries (i.e., crates). Teaclave TrustZone SDK is a sub-project of
Apache Teaclave™ (incubating). To learn more about the design and history of
TrustZone SDK,
please read the blog <a href="https://teaclave.apache.org/blog/2021-03-14-welcome-rust-optee-trustzone-sdk/" target="_blank" rel="noopener noreferrer">Welcome Rust OP-TEE TrustZone SDK To Teaclave</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="highlights">Highlights<a href="#highlights" class="hash-link" aria-label="Direct link to Highlights" title="Direct link to Highlights">​</a></h2>
<p>This version implements the following Rust APIs in GlobalPlatform TEE
specifications:</p>
<p><strong>TEE Client API</strong> (<code>optee-teec</code>)</p>
<ul>
<li>Context</li>
<li>Error</li>
<li>Operation</li>
<li>Parameter</li>
<li>Session</li>
<li>UUID</li>
</ul>
<p><strong>TEE Internal Core API</strong> (<code>optee-utee</code>)</p>
<ul>
<li>Arithmetical</li>
<li>Crypto Operation</li>
<li>Error</li>
<li>Object</li>
<li>Parameter</li>
<li>Time</li>
<li>Trace</li>
</ul>
<p>Here is a demonstration of using these Rust APIs to open a session and invoke a
function to TA.</p>
<p><img decoding="async" loading="lazy" alt="Teaclave TrustZone SDK APIs" src="/assets/images/teaclave-trustzone-sdk-apis-151d6d694e0305ffe603015e158c1e57.png" width="2204" height="1364" class="img_ev3q"></p>
<p>We also provides procedure macros to automatically generate bindings interfaces of TA:</p>
<ul>
<li><code>#[ta_create]</code>, <code>#[ta_destroy]</code>, <code>#[ta_open_session]</code>, <code>#[ta_close_session]</code>, <code>#[ta_invoke_command]</code></li>
</ul>
<p>These annotations will automatically generate helper functions to bridge the normal/secure worlds.</p>
<p><img decoding="async" loading="lazy" alt="Teaclave TrustZone SDK Macros" src="/assets/images/teaclave-trustzone-sdk-macros-ca78ab7fc499178c82f7aba8313a0bc4.png" width="2158" height="1530" class="img_ev3q"></p>
<p>This version includes rewrites of all examples (e.g., AES, authentication, big
integer, HOTP) from OP-TEE repository. In addition, we include more examples
using <code>serde</code> for serialization and deserialization.</p>
<p><img decoding="async" loading="lazy" alt="Examples in Teaclave TrustZone SDK" src="/assets/images/teaclave-trustzone-sdk-examples-478d03e03e0654fe3e67ec1fbefe9918.png" width="2254" height="1318" class="img_ev3q"></p>
<p>This version is compatible with OP-TEE 3.13.0.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-started">Getting Started<a href="#getting-started" class="hash-link" aria-label="Direct link to Getting Started" title="Direct link to Getting Started">​</a></h2>
<p>Here is a simple instruction to download, build and test the TrustZone SDK:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget https://dist.apache.org/repos/dist/dev/incubator/teaclave/trustzone-sdk-0.1.0-rc.1/apache-teaclave-trustzone-sdk-0.1.0-rc.1-incubating.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ tar zxvf apache-teaclave-trustzone-sdk-0.1.0-rc.1-incubating.tar.gz &amp;&amp; cd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apache-teaclave-trustzone-sdk-0.1.0-incubating</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ # Instructions to verify the source tar:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">https://teaclave.apache.org/download/#verify-the-integrity-of-the-files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ # Building</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run --rm -it -v$(pwd):/teaclave-trustzone-sdk -w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/teaclave-trustzone-sdk teaclave/teaclave-trustzone-sdk-build:0.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bash -c &quot;source environment &amp;&amp; make&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ # Testing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run --rm -it -v$(pwd):/teaclave-trustzone-sdk -w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/teaclave-trustzone-sdk teaclave/teaclave-trustzone-sdk-build:0.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bash -c &quot;source environment &amp;&amp; cd ci &amp;&amp; ./ci.sh&quot;</span><br></span></code></pre></div></div>
<p>We also provide a document <a href="https://teaclave.apache.org/trustzone-sdk-docs/getting-started-with-optee-for-qemu-armv8/" target="_blank" rel="noopener noreferrer">Getting Started with OP-TEE for QEMU
ARMv8</a>
to get started step by step.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="download">Download<a href="#download" class="hash-link" aria-label="Direct link to Download" title="Direct link to Download">​</a></h2>
<p>You can download the release from the
<a href="https://teaclave.apache.org/download/" target="_blank" rel="noopener noreferrer">download</a> page. Also, please checkout
our <a href="https://github.com/apache/incubator-teaclave-trustzone-sdk" target="_blank" rel="noopener noreferrer">repository</a>
hosted on GitHub.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="contributing">Contributing<a href="#contributing" class="hash-link" aria-label="Direct link to Contributing" title="Direct link to Contributing">​</a></h2>
<p>Teaclave TrustZone SDK is under the Apache License v2 and open source in The
Apache Way. We aim to create a project that is maintained and owned by the
community. All kinds of contributions are welcome. Thanks to our contributors.</p></div></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog"><div class="pagination-nav__label">Newer entries</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/3"><div class="pagination-nav__label">Older entries</div></a></nav></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright"><div style="font-size:.7rem; text-align:left;">Apache Teaclave™ (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF. Copyright © 2020 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache Teaclave™, Apache, the Apache feather, and the Apache Teaclave™ project logo are either trademarks or registered trademarks of the Apache Software Foundation.</div></div></div></div></footer></div>
</body>
</html>