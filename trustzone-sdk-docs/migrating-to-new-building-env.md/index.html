<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-teaclave-trustzone-sdk/docs/migrating-to-new-building-env" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Migrating To New Building ENV | Apache Teaclave™ (incubating)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://teaclave.apache.org/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://teaclave.apache.org/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://teaclave.apache.org/trustzone-sdk-docs/migrating-to-new-building-env.md"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Migrating To New Building ENV | Apache Teaclave™ (incubating)"><meta data-rh="true" name="description" content="After optee-utee-build release, this doc is keeping for developers"><meta data-rh="true" property="og:description" content="After optee-utee-build release, this doc is keeping for developers"><link data-rh="true" rel="canonical" href="https://teaclave.apache.org/trustzone-sdk-docs/migrating-to-new-building-env.md"><link data-rh="true" rel="alternate" href="https://teaclave.apache.org/trustzone-sdk-docs/migrating-to-new-building-env.md" hreflang="en"><link data-rh="true" rel="alternate" href="https://teaclave.apache.org/trustzone-sdk-docs/migrating-to-new-building-env.md" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Migrating to New Building Environment","item":"https://teaclave.apache.org/trustzone-sdk-docs/migrating-to-new-building-env.md"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Teaclave™ (incubating) RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Teaclave™ (incubating) Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e2b519a3.css">
<script src="/assets/js/runtime~main.b9db7108.js" defer="defer"></script>
<script src="/assets/js/main.d9920c39.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Apache Teaclave™" class="themedComponent_mlkZ themedComponent--light_NVdE" style="height:2.5rem;max-width:300px;padding-left:1.6rem;position:relative;top:0.1rem"><img src="/img/logo.svg" alt="Apache Teaclave™" class="themedComponent_mlkZ themedComponent--dark_xIcU" style="height:2.5rem;max-width:300px;padding-left:1.6rem;position:relative;top:0.1rem"></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/powered-by">Powered By</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" file="community/community.md" href="/community">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" file="community/contributing.md" href="/contributing">Contributing</a></li><li><a class="dropdown__link" file="community/contributors.md" href="/contributors">Contributors</a></li><li><a class="dropdown__link" file="community/becoming-a-member.md" href="/becoming-a-member">Becoming a Member</a></li><li><a class="dropdown__link" file="community/maturity.md" href="/maturity">Maturity Assessment</a></li><li><a class="dropdown__link" file="community/release-guide.md" href="/release-guide">Release Guide</a></li></ul></div><a class="navbar__item navbar__link" href="/download">Download</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" file="overview.md" href="/overview">Docs</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" file="teaclave-trustzone-sdk/docs/README.md" href="/trustzone-sdk-docs/">Teaclave TrustZone SDK</a></li><li><a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee_teec" target="_self" rel="" class="dropdown__link">API Docs: Teaclave TrustZone SDK (Host)<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://teaclave.apache.org/api-docs/trustzone-sdk/optee_utee" target="_self" rel="" class="dropdown__link">API Docs: Teaclave TrustZone SDK (TA)<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a class="dropdown__link" file="teaclave-sgx-sdk/documents/README.md" href="/sgx-sdk-docs/">Teaclave SGX SDK</a></li><li><a href="https://teaclave.apache.org/api-docs/sgx-sdk/" target="_self" rel="" class="dropdown__link">API Docs: Teaclave SGX SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a class="dropdown__link" file="teaclave-docs/README.md" href="/teaclave-docs/">Teaclave</a></li><li><a class="dropdown__link" file="teaclave-faas-legacy/docs/README.md" href="/docs/">Teaclave FaaS (legacy)</a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Repos</a><ul class="dropdown__menu"><li><a href="https://github.com/apache/incubator-teaclave" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-sgx-sdk" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave SGX SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-trustzone-sdk" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave TrustZone SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-java-tee-sdk" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave Java TEE SDK<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/apache/incubator-teaclave-website" target="_blank" rel="noopener noreferrer" class="dropdown__link">Teaclave Website<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">ASF Homepage<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events<svg width="12" height="12" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/trustzone-sdk-docs/emulate-and-dev-in-docker.md">Quick Start</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/trustzone-sdk-docs/emulate-and-dev-in-docker.md">Quick Emulation And Development in Docker</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/trustzone-sdk-docs/emulate-and-dev-in-docker-std.md">Developing TAs with Rust Standard Library in Docker</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/trustzone-sdk-docs/ta-development-modes.md">Development</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/trustzone-sdk-docs/ta-development-modes.md">TA Development Modes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/trustzone-sdk-docs/overview-of-optee-rust-examples">Overview of OP-TEE Rust Examples</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/trustzone-sdk-docs/writing-rust-tas-using-optee-utee-build.md">Writing Rust TAs using optee-utee-build</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/trustzone-sdk-docs/building-rust-ca-as-android-elf.md">Building Rust CA as Android ELF</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/trustzone-sdk-docs/advanced-setup.md">Advanced Topics</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/trustzone-sdk-docs/advanced-setup.md">Advanced Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/trustzone-sdk-docs/expanding-ta-secure-memory-on-qemuv8.md">Expanding TA Secure Memory on QEMUv8</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/trustzone-sdk-docs/migrating-to-new-building-env.md">Migrating to New Building Environment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/trustzone-sdk-docs/debugging-optee-ta.md">Debugging OP-TEE TA</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Advanced Topics</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Migrating to New Building Environment</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Migrating To New Building ENV</h1></header>
<blockquote>
<p>After optee-utee-build release, this doc is keeping for developers
who intend to know the detail of building process, we suggest use
<a href="/trustzone-sdk-docs/writing-rust-tas-using-optee-utee-build.md">optee-utee-build</a> for building
instead.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="migration-guide-moving-from-master-to-main-branch-post-oct-2024">Migration Guide: Moving from <code>master</code> to <code>main</code> Branch (Post-Oct 2024)<a href="#migration-guide-moving-from-master-to-main-branch-post-oct-2024" class="hash-link" aria-label="Direct link to migration-guide-moving-from-master-to-main-branch-post-oct-2024" title="Direct link to migration-guide-moving-from-master-to-main-branch-post-oct-2024">​</a></h2>
<p>Since the <code>main</code> branch (after October 2024) introduces breaking changes
to the build environment, if users of the legacy <code>master</code> branch want to
keep upstream or use a new version of the Rust toolchain, they will need
to migrate their TA to the new environment.</p>
<p>Note that the migration is mainly for building scripts to support both
<code>no-std</code> and <code>std</code> building for TA, no need for modifying your application
code.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="current-structure">Current Structure<a href="#current-structure" class="hash-link" aria-label="Direct link to Current Structure" title="Direct link to Current Structure">​</a></h3>
<p>We have retained almost the same structure as the original but removed
<code>ta_arm.lds</code> and <code>ta_aarch64.lds</code> from the directory structure. Besides
we have some modification on <code>ta/ta_static.rs</code>, <code>ta/build.rs</code> and all
<code>Makefile</code>s. (See the explanation in next part).</p>
<p>For example the current <code>examples/acipher-rs/</code>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">examples/acipher-rs/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── main.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── build.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └── lib.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── ta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── build.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── src</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │   └── main.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── ta_static.rs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── Xargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── uuid.txt</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="changes-in-build-scripts">Changes in Build Scripts<a href="#changes-in-build-scripts" class="hash-link" aria-label="Direct link to Changes in Build Scripts" title="Direct link to Changes in Build Scripts">​</a></h3>
<ol>
<li>
<p><strong>TA linking script</strong>: <code>ta_arm.lds</code> and <code>ta_aarch64.lds</code>.<br>
These linking scripts define the low-level TA ELF sections arrangement
(e.g., <code>.text</code> section in ELF). They have been removed, and we now use
the <code>lds</code> file from OP-TEE&#x27;s TA dev-kit, for example, located in
<code>optee_os/out/arm-plat-vexpress/export-ta_arm64/src/ta.ld.S</code>. This
change helps to stay upstream with OP-TEE OS and makes it more stable
when running on OP-TEE OS.</p>
</li>
<li>
<p><strong><code>ta_static.rs</code></strong>: C FFI primitives, such as <code>ta_heap_size</code> and <code>ta_props</code>.<br>
This file helps to set TA properties in a C-like manner in the TA ELF
for OP-TEE OS to load.<br>
The change involves modifying imports of primitives, e.g., from
<code>libc::c_int</code> to <code>core::c_int</code>, and from <code>std::u64::MAX</code> to
<code>core::primitive::u64::MAX</code>. This helps ensure support for both <code>no_std</code>
and <code>std</code>-based environments.</p>
</li>
<li>
<p><strong><code>build.rs</code></strong>:<br>
Since TA is not a normal ELF, it has a header before the ELF sections.<br>
This file is the main entry point for building a TA as ELF and adding
the specific header. It uses configurations such as <code>ta_static.rs</code>,
<code>user_ta_header.rs</code>, and the linking script <code>ta.ld.S</code>. It also defines
the linking with OP-TEE&#x27;s C libraries (<code>libutee</code> and <code>libutils</code>) from
OP-TEE&#x27;s TA dev-kit.</p>
<p>The changes are:</p>
<p>a. Move linking parameters from the original
<a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/blob/master/.cargo/config" target="_blank" rel="noopener noreferrer"><code>/.cargo/config</code></a>:
This change is primarily designed to accommodate more complex build targets.
For standard TAs, the specific build targets are <code>aarch64-unknown-optee-trustzone</code>
and <code>arm-unknown-optee-trustzone</code>.
For example, in the no-std mode for aarch64, both no-std TAs and CAs are built
with the <code>aarch64-unknown-linux-gnu</code> target. However, in std mode, TAs are
built with the <code>aarch64-unknown-optee-trustzone</code> target, while CAs remain
built with the <code>aarch64-unknown-linux-gnu</code> target.
This change allows us to decouple TA&#x27;s linking parameters from the target, as
they are now defined within TA&#x27;s <code>build.rs</code>.</p>
<p>b. Add <code>cargo:rustc-link-arg=--no-warn-mismatch</code> to work around
the EABI version mismatch linking error: symbols.o with EABI version 0
and other objects are EABI version 5.</p>
</li>
<li>
<p><strong>ENV variables</strong>:<br>
The original script for setting the toolchain path has some modifications.
Due to the more complex building options mentioned above, <code>CROSS_COMPILE_{HOST, TA}</code>
and <code>TARGET_{HOST, TA}</code> should be set by <code>source environment</code>.
You should also set whether you want to build in <code>STD</code> mode (<code>export STD=y</code>)
and specify the target architecture (<code>ARM32</code> or <code>AArch64</code>) for both CA and TA.
Running <code>source environment</code> will set up all toolchains and libraries.</p>
</li>
<li>
<p><strong>Makefile Polishing</strong>:<br>
a. Top-level Makefile (<code>examples/*/Makefile</code>): Reads the <code>CROSS_COMPILE_{HOST, TA}</code>
and <code>TARGET_{HOST, TA}</code>.<br>
b. <code>host/Makefile</code>: Simplified and polished for the changes in ENV variables.<br>
c. <code>ta/Makefile</code>: For <code>std</code> TAs, checks if the <code>STD</code> environment variable is set,
and further simplifications and polish are done.</p>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-migrating-projects">Step 1: Migrating Projects<a href="#step-1-migrating-projects" class="hash-link" aria-label="Direct link to Step 1: Migrating Projects" title="Direct link to Step 1: Migrating Projects">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="case-1-default-migration-no-custom-modifications-to-build-scripts">Case 1: Default Migration (No Custom Modifications to Build Scripts)<a href="#case-1-default-migration-no-custom-modifications-to-build-scripts" class="hash-link" aria-label="Direct link to Case 1: Default Migration (No Custom Modifications to Build Scripts)" title="Direct link to Case 1: Default Migration (No Custom Modifications to Build Scripts)">​</a></h4>
<p>If you have developed based on one of our example structures and haven&#x27;t
modified the build scripts mentioned above, you can simply copy a current
example and move your code into it.<br>
Note that the <code>Makefile</code> for <code>std</code> TAs has tiny differences from the <code>no_std</code>
one. If you are using a <code>no_std</code> TA, refer to <code>hello_world-rs</code>. For <code>std</code> TAs,
refer to <code>serde-rs</code>.</p>
<p>We provide a shell script to assist with this migration (you may need to make
small adjustments based on whether you are building in <code>no_std</code> or <code>std</code> mode).
Here is an example for <code>no_std</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TARGET_EXAMPLE=&quot;your_project&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OLD_ROOT_PATH=&quot;/path/to/old/sdk&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NEW_PATH=&quot;/path/to/current/sdk&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Duplicate the hello-world example in the new path as a template</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp -r ${NEW_PATH}/examples/hello_world-rs ${NEW_PATH}/examples/${TARGET_EXAMPLE}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Remove the source code directory and copy from the old path to the new path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># including: src/ and Cargo.toml in host, ta, proto</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(cd ${NEW_PATH}/examples/${TARGET_EXAMPLE}/host &amp;&amp; rm -rf src/ Cargo.* &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp -r ${OLD_ROOT_PATH}/examples/${TARGET_EXAMPLE}/host/src . &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ${OLD_ROOT_PATH}/examples/${TARGET_EXAMPLE}/host/Cargo.toml .)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(cd ${NEW_PATH}/examples/${TARGET_EXAMPLE}/ta &amp;&amp; rm -rf src/ Cargo.* &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp -r ${OLD_ROOT_PATH}/examples/${TARGET_EXAMPLE}/ta/src . &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ${OLD_ROOT_PATH}/examples/${TARGET_EXAMPLE}/ta/Cargo.toml .)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(cd ${NEW_PATH}/examples/${TARGET_EXAMPLE}/proto &amp;&amp; rm -rf src/ Cargo.* &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp -r ${OLD_ROOT_PATH}/examples/${TARGET_EXAMPLE}/proto/src . &amp;&amp; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ${OLD_ROOT_PATH}/examples/${TARGET_EXAMPLE}/proto/Cargo.toml .)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Copy the UUID file from the old path to the new path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cp ${OLD_ROOT_PATH}/examples/${TARGET_EXAMPLE}/uuid.txt \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${NEW_PATH}/examples/${TARGET_EXAMPLE}/uuid.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Update binary names in host/Cargo.toml and host/Makefile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -i &quot;s/hello_world-rs/${TARGET_EXAMPLE}/g&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${NEW_PATH}/examples/${TARGET_EXAMPLE}/host/Cargo.toml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sed -i &quot;s/hello_world-rs/${TARGET_EXAMPLE}/g&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">${NEW_PATH}/examples/${TARGET_EXAMPLE}/host/Makefile</span><br></span></code></pre></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="case-2-custom-migration-with-modified-build-scripts">Case 2: Custom Migration (With Modified Build Scripts)<a href="#case-2-custom-migration-with-modified-build-scripts" class="hash-link" aria-label="Direct link to Case 2: Custom Migration (With Modified Build Scripts)" title="Direct link to Case 2: Custom Migration (With Modified Build Scripts)">​</a></h4>
<p>If you have made changes to your build scripts, follow the steps below to
manually migrate those files:</p>
<ol>
<li>
<p><strong>TA linking script <code>ta_arm.lds</code> and <code>ta_aarch64.lds</code></strong>:<br>
Usually, developers don&#x27;t need to modify those files. If you have made any
changes, compare the diff between your file and
<code>optee_os/out/arm-plat-vexpress/export-ta_{arm64, arm32}/src/ta.ld.S</code> in the
current SDK.
This <code>ta.ld.S</code> file is currently not included in SDK but in OPTEE_OS repo.</p>
</li>
<li>
<p><strong><code>ta_static.rs</code></strong>:<br>
Usually, developers don&#x27;t need to modify this file. If you have made
modifications to this file, compare them with the latest version here:<br>
<a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/compare/cd19ac2e1c3cb1a848d5131d4af8138d84be8708..9e3906e9d82f0471e96bf892afe0df37dd90a86e#diff-c0cdd7b28f558bd417069b8e60ed35b70ac1cd01e68e3c0ba6c7311a5a444e22" target="_blank" rel="noopener noreferrer">ta_static.rs diff</a></p>
</li>
<li>
<p><strong><code>build.rs</code></strong>:<br>
Usually, developers don&#x27;t need to modify this file. If you have made
changes to link other libraries or dependencies in <code>build.rs</code>, compare
the two versions and migrate accordingly:<br>
<a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/compare/cd19ac2e1c3cb1a848d5131d4af8138d84be8708..9e3906e9d82f0471e96bf892afe0df37dd90a86e#diff-c07432a8a8ecbc1f00799a2bd008bd8dcbba9d58fd0a9e5815b835e4ed425e86" target="_blank" rel="noopener noreferrer">build.rs diff</a></p>
</li>
<li>
<p><strong>Makefiles</strong>:<br>
You may have modified some of the Makefiles. Please compare them
with the current versions to ensure compatibility:</p>
</li>
</ol>
<ul>
<li>
<p><strong>For <code>no_std</code> builds</strong>:</p>
<ul>
<li><a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/compare/cd19ac2e1c3cb1a848d5131d4af8138d84be8708..dc1523cbcf6c716213854d9a16d39b8d498a9bb6#diff-df315bfec3c0b8e84c64b31e4450660ea66c33aa833f5b1b9d76250481c15887" target="_blank" rel="noopener noreferrer">Top-level Makefile</a></li>
<li><a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/compare/cd19ac2e1c3cb1a848d5131d4af8138d84be8708..dc1523cbcf6c716213854d9a16d39b8d498a9bb6#diff-96468cc392cceb21806dbfb2dd24007d772f19992955ed81c4979a45f753378a" target="_blank" rel="noopener noreferrer">Host Makefile</a></li>
<li><a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/compare/cd19ac2e1c3cb1a848d5131d4af8138d84be8708..dc1523cbcf6c716213854d9a16d39b8d498a9bb6#diff-29c530c8f83308f34fae9b3516015f07fa80c1b879cc9a8834c4dfaa497af1a5" target="_blank" rel="noopener noreferrer">TA Makefile</a></li>
</ul>
</li>
<li>
<p><strong>For <code>std</code> builds</strong>:</p>
<ul>
<li><a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/compare/cd19ac2e1c3cb1a848d5131d4af8138d84be8708..dc1523cbcf6c716213854d9a16d39b8d498a9bb6#diff-15685120d44f0ca4ea11ac90799a621f19378cebf5b018792ebc25bee68c3824" target="_blank" rel="noopener noreferrer">Top-level Makefile</a></li>
<li><a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/compare/cd19ac2e1c3cb1a848d5131d4af8138d84be8708..dc1523cbcf6c716213854d9a16d39b8d498a9bb6#diff-dfb3cbc25e6b4bad652b716b9d051c9fb7c45d2d8303caa936666774c49a624a" target="_blank" rel="noopener noreferrer">Host Makefile</a></li>
<li><a href="https://github.com/apache/incubator-teaclave-trustzone-sdk/compare/cd19ac2e1c3cb1a848d5131d4af8138d84be8708..dc1523cbcf6c716213854d9a16d39b8d498a9bb6#diff-e0618a8a49e0ac65dd1acd48a0108c280a3821bcfb233f46f4baa56c77369001" target="_blank" rel="noopener noreferrer">TA Makefile</a></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-update-cargotoml">Step 2: <strong>Update <code>Cargo.toml</code></strong><a href="#step-2-update-cargotoml" class="hash-link" aria-label="Direct link to step-2-update-cargotoml" title="Direct link to step-2-update-cargotoml">​</a></h3>
<p>You may need to update your <code>Cargo.toml</code> file to include newer
versions of crates that depend on the new Rust toolchain. Refer to
the <code>rust-toolchain.toml</code> file to verify the current toolchain. If
you update any crates, be prepared for potential code changes to
accommodate new interfaces.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step-3-build-and-resolve-errors">Step 3: <strong>Build and Resolve Errors</strong><a href="#step-3-build-and-resolve-errors" class="hash-link" aria-label="Direct link to step-3-build-and-resolve-errors" title="Direct link to step-3-build-and-resolve-errors">​</a></h3>
<p>After updating the necessary files, rebuild the project. During the
process, errors might arise due to crate version mismatches or
other updates. Make sure to resolve these errors by adjusting your
code accordingly.</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/trustzone-sdk-docs/expanding-ta-secure-memory-on-qemuv8.md"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Expanding TA Secure Memory on QEMUv8</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/trustzone-sdk-docs/debugging-optee-ta.md"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Debugging OP-TEE TA</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#migration-guide-moving-from-master-to-main-branch-post-oct-2024" class="table-of-contents__link toc-highlight">Migration Guide: Moving from <code>master</code> to <code>main</code> Branch (Post-Oct 2024)</a><ul><li><a href="#current-structure" class="table-of-contents__link toc-highlight">Current Structure</a></li><li><a href="#changes-in-build-scripts" class="table-of-contents__link toc-highlight">Changes in Build Scripts</a></li><li><a href="#step-1-migrating-projects" class="table-of-contents__link toc-highlight">Step 1: Migrating Projects</a></li><li><a href="#step-2-update-cargotoml" class="table-of-contents__link toc-highlight">Step 2: <strong>Update <code>Cargo.toml</code></strong></a></li><li><a href="#step-3-build-and-resolve-errors" class="table-of-contents__link toc-highlight">Step 3: <strong>Build and Resolve Errors</strong></a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright"><div style="font-size:.7rem; text-align:left;">Apache Teaclave™ (incubating) is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF. Copyright © 2020 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache Teaclave™, Apache, the Apache feather, and the Apache Teaclave™ project logo are either trademarks or registered trademarks of the Apache Software Foundation.</div></div></div></div></footer></div>
</body>
</html>